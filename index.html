<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- Mobile responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medieval Idle Adventure â€“ Ultimate Edition</title>
  <!-- Google Fonts for a medieval look -->
  <link href="https://fonts.googleapis.com/css?family=Cinzel:400,700|MedievalSharp" rel="stylesheet">
  <style>
    /* Global styles */
    body {
      font-family: 'Cinzel', serif;
      background: url("https://www.transparenttextures.com/patterns/paper.png");
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: #8b4513;
      color: #fff;
      padding: 20px;
      text-align: center;
      font-family: 'MedievalSharp', cursive;
      font-size: 2.5em;
      text-shadow: 2px 2px #000;
      border-bottom: 3px solid #5a2d0c;
      position: relative;
    }
    #headerExtras {
      font-size: 0.6em;
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    /* Notification */
    #notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(139,69,19,0.9);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s ease, transform 0.5s ease;
      z-index: 2000;
    }
    #notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    /* Twoâ€‘column layout */
    #container {
      display: flex;
      gap: 20px;
      padding: 20px;
      flex-wrap: wrap;
    }
    #mainColumn {
      flex: 2;
      min-width: 300px;
    }
    #sidebarColumn {
      flex: 1;
      min-width: 280px;
    }
    /* Section styling */
    .section {
      border: 2px solid #8b4513;
      border-radius: 8px;
      padding: 20px;
      background: #fffaf0;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;
    }
    .section:hover {
      transform: scale(1.02);
    }
    h2, h3 {
      margin-top: 0;
      font-family: 'MedievalSharp', cursive;
      color: #8b4513;
    }
    button {
      padding: 10px 20px;
      background: #8b4513;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
      font-size: 1em;
      transition: background 0.3s, transform 0.1s;
    }
    button:hover {
      background: #a0522d;
    }
    button:active {
      transform: scale(0.98);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status p { margin: 5px 0; }
    /* Progress bars */
    #xpBarContainer, #enemyHealthBarContainer, #specialCooldownBarContainer {
      width: 100%;
      background: #ccc;
      border: 1px solid #8b4513;
      height: 20px;
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
    }
    #xpBar, #enemyHealthBar, #specialCooldownBar {
      height: 100%;
      width: 0%;
      transition: width 0.5s;
    }
    #xpBar { background: #ffd700; }
    #enemyHealthBar { background: #ff4500; }
    #specialCooldownBar { background: #00bfff; }
    /* Floating gold */
    .gold-float {
      position: absolute;
      font-size: 20px;
      font-weight: bold;
      color: gold;
      pointer-events: none;
      z-index: 1000;
      animation: floatUp 1.5s ease-out forwards;
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0px); }
      100% { opacity: 0; transform: translateY(-50px); }
    }
    /* Royal Herald */
    .royal-herald {
      position: fixed;
      background: gold;
      color: black;
      padding: 10px 20px;
      border: 2px solid darkgoldenrod;
      border-radius: 8px;
      font-family: 'MedievalSharp', cursive;
      font-size: 1.2em;
      z-index: 3000;
      cursor: pointer;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* Quest list */
    #questList li {
      list-style: none;
      margin: 5px 0;
    }
    #questList li.completed {
      text-decoration: line-through;
      color: green;
      animation: fadeIn 1s;
    }
    /* Seasonal event */
    #seasonalStatus {
      font-weight: bold;
      color: darkred;
    }
    /* Leaderboard */
    #leaderboardList {
      list-style-type: none;
      padding: 0;
    }
    #leaderboardList li {
      padding: 4px;
      border-bottom: 1px solid #ccc;
    }
    /* Tutorial overlay */
    #tutorialOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 3000;
      padding: 20px;
    }
    #tutorialOverlay button {
      margin-top: 20px;
    }
    /* Settings modal */
    #settingsModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fffaf0;
      border: 2px solid #8b4513;
      padding: 20px;
      z-index: 3000;
      display: none;
      width: 300px;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
    }
    #settingsModal h3 {
      margin-top: 0;
      text-align: center;
    }
    #settingsModal label {
      display: block;
      margin-top: 10px;
    }
    /* Settings button */
    #settingsButton {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      font-size: 0.8em;
      background: #a0522d;
    }
    /* QTE Button */
    #qteButton {
      display: none;
      position: fixed;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #ff6347;
      color: white;
      border: 2px solid #8b4513;
      border-radius: 8px;
      padding: 15px 30px;
      font-family: 'MedievalSharp', cursive;
      font-size: 1.2em;
      z-index: 2500;
    }
    /* Archery Mini-Game Modal */
    #archeryModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fffaf0;
      border: 2px solid #8b4513;
      padding: 20px;
      z-index: 3500;
      display: none;
      width: 300px;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
      text-align: center;
    }
    #archeryTarget {
      width: 100px;
      height: 100px;
      background: red;
      border-radius: 50%;
      margin: 20px auto;
      position: relative;
      cursor: pointer;
    }
    /* Potion Mixing Mini-Game Modal (New Improvement 9) */
    #potionModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fffaf0;
      border: 2px solid #8b4513;
      padding: 20px;
      z-index: 3500;
      display: none;
      width: 300px;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
      text-align: center;
    }
    #potionModal h3 {
      margin-bottom: 10px;
    }
    #potionButtons button {
      margin: 5px;
      padding: 10px 15px;
    }
    /* Journal section styling */
    #journalSection {
      border: 2px solid #8b4513;
      border-radius: 8px;
      padding: 10px;
      background: #fffaf0;
      margin-top: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    /* Media queries for mobile enhancements */
    @media (max-width: 600px) {
      button {
        font-size: 1.2em;
        padding: 15px 25px;
      }
    }
  </style>
</head>
<body>
  <!-- Audio elements -->
  <audio id="backgroundMusic" src="background-music.mp3" loop></audio>
  <audio id="clickSound" src="click.mp3"></audio>
  <audio id="levelUpSound" src="levelup.mp3"></audio>
  <audio id="enemyDefeatedSound" src="enemy-defeated.mp3"></audio>
  <audio id="upgradeSound" src="upgrade.mp3"></audio>
  <audio id="poisonSound" src="poison.mp3"></audio>
  <audio id="qteSuccessSound" src="qte-success.mp3"></audio>

  <!-- Settings Button -->
  <button id="settingsButton" title="Open Settings">Settings</button>

  <header>
    Medieval Idle Adventure â€“ Ultimate Edition
    <div id="headerExtras">
      <div>Prestige Level: <span id="headerPrestigeLevel">0</span></div>
      <div>Gold Multiplier: <span id="headerPrestigeMultiplier">1.0</span>x</div>
      <div>High Score: <span id="headerHighScore">0</span></div>
      <div>Relics: <span id="headerRelics">0</span></div>
      <div>Mystic Runes: <span id="headerMysticRunes">0</span></div>
    </div>
  </header>

  <!-- Notification -->
  <div id="notification"></div>

  <!-- Tutorial Overlay -->
  <div id="tutorialOverlay" style="display:none;">
    <h2>Welcome to Medieval Idle Adventure!</h2>
    <p>
      Tap the treasure chest to gather gold, upgrade your abilities, battle diverse foes, and uncover ancient lore.
      Choose your hero specialization in Settings to tailor your gameplay style.
      Explore quests, miniâ€‘games, and community challenges. Good luck, brave hero!
    </p>
    <button id="dismissTutorial">Got It!</button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal">
    <h3>Settings</h3>
    <label>
      Music Volume:
      <input type="range" id="musicVolumeSlider" min="0" max="1" step="0.05">
    </label>
    <label>
      SFX Volume:
      <input type="range" id="sfxVolumeSlider" min="0" max="1" step="0.05">
    </label>
    <label>
      <input type="checkbox" id="muteToggle"> Mute All Sounds
    </label>
    <label>
      Difficulty:
      <select id="difficultySelect">
        <option value="0.8">Easy</option>
        <option value="1" selected>Normal</option>
        <option value="1.2">Hard</option>
      </select>
    </label>
    <label>
      <input type="checkbox" id="challengeModeToggle"> Enable Challenge Mode
    </label>
    <label>
      Hero Specialization:
      <select id="specializationSelect">
        <option value="Warrior" selected>Warrior</option>
        <option value="Merchant">Merchant</option>
        <option value="Mage">Mage</option>
      </select>
    </label>
    <button id="closeSettings">Close</button>
  </div>

  <!-- QTE Button -->
  <button id="qteButton">Quick Strike!</button>

  <!-- Archery Mini-Game Modal -->
  <div id="archeryModal">
    <h3>Archery Challenge</h3>
    <p>Hit the target for bonus gold and Mystic Runes!</p>
    <div id="archeryTarget"></div>
    <button id="closeArchery">Close</button>
  </div>

  <!-- Potion Mixing Mini-Game Modal (New Improvement 9) -->
  <div id="potionModal">
    <h3>Potion Mixing Challenge</h3>
    <p>Mix the potion by clicking the ingredients in the correct order: Herb â†’ Mushroom â†’ Crystal.</p>
    <div id="potionButtons">
      <button class="potionBtn" data-ingredient="Herb">Herb</button>
      <button class="potionBtn" data-ingredient="Mushroom">Mushroom</button>
      <button class="potionBtn" data-ingredient="Crystal">Crystal</button>
    </div>
    <button id="closePotion">Close</button>
  </div>

  <!-- Container with two columns -->
  <div id="container">
    <!-- Main Column -->
    <div id="mainColumn">
      <!-- Clicker Section -->
      <div class="section" id="clickerSection">
        <h2>Clicker</h2>
        <p>Tap the treasure chest to gather gold!</p>
        <button id="clickButton" title="Click to earn gold!">ðŸ’° Click Me!</button>
        <div class="status">
          <p>Gold: <span id="goldDisplay">0</span></p>
          <p>Gold Per Click: <span id="goldPerClickDisplay">1</span></p>
          <p>Critical Strike Chance: <span id="critChanceDisplay">10%</span></p>
          <p>Critical Multiplier: <span id="critMultiplierDisplay">2.0x</span></p>
          <p>
            Upgrade Critical Strike (Increase chance by 5%): Cost:
            <span id="critUpgradeCostDisplay">50</span> Gold
          </p>
          <button id="upgradeCrit" title="Increase crit chance by 5%">Upgrade Critical Strike</button>
        </div>
      </div>

      <!-- Resource Management Section -->
      <div class="section" id="resourceSection">
        <h2>Resource Management</h2>
        <p>Purchase buildings and upgrades to generate gold automatically.</p>
        <!-- Gold Mine -->
        <div>
          <p><strong>Gold Mine</strong> (Generates 1 gold per second)</p>
          <p>Cost: <span id="goldMineCost">10</span> Gold</p>
          <button id="buyGoldMine" title="Purchase a Gold Mine">Buy Gold Mine</button>
          <p>Owned: <span id="goldMineOwned">0</span></p>
        </div>
        <!-- Upgrade Click -->
        <div style="margin-top: 10px;">
          <p><strong>Upgrade Click Power</strong> (Increase gold per click by 1)</p>
          <p>Cost: <span id="clickUpgradeCost">25</span> Gold</p>
          <button id="upgradeClick" title="Increase click gold">Upgrade Click</button>
        </div>
        <!-- Auto Clicker -->
        <div style="margin-top: 10px;">
          <p><strong>Auto Clicker</strong> (Automatically clicks using your heroes)</p>
          <p>Cost: <span id="autoClickerCost">50</span> Gold</p>
          <button id="buyAutoClicker" title="Buy an Auto Clicker">Buy Auto Clicker</button>
          <p>Owned: <span id="autoClickerOwned">0</span></p>
        </div>
        <!-- Blacksmith -->
        <div style="margin-top: 10px;">
          <p><strong>Blacksmith</strong> (Increase hero attack by 1)</p>
          <p>Cost: <span id="blacksmithCost">100</span> Gold</p>
          <button id="hireBlacksmith" title="Hire a Blacksmith">Hire Blacksmith</button>
          <p>Level: <span id="blacksmithLevel">0</span></p>
        </div>
        <!-- Adventurer's Guild -->
        <div style="margin-top: 10px;">
          <p><strong>Adventurer's Guild</strong> (Increase passive income by 5% per level)</p>
          <p>Cost: <span id="guildCost">100</span> Gold</p>
          <button id="buyGuild" title="Upgrade Adventurer's Guild">Buy Adventurer's Guild</button>
          <p>Level: <span id="guildLevel">0</span></p>
        </div>
        <!-- Mage Tower -->
        <div style="margin-top: 10px;">
          <p><strong>Mage Tower</strong> (Increase critical multiplier by 0.1 per level)</p>
          <p>Cost: <span id="mageTowerCost">150</span> Gold</p>
          <button id="buyMageTower" title="Buy Mage Tower">Buy Mage Tower</button>
          <p>Level: <span id="mageTowerLevel">0</span></p>
        </div>
      </div>

      <!-- Hero & Battles Section -->
      <div class="section" id="rpgSection">
        <h2>Hero & Battles</h2>
        <div id="heroStatus">
          <p>Hero Level: <span id="heroLevel">1</span></p>
          <p>Hero XP: <span id="heroXP">0</span> / <span id="heroXPNeeded">50</span></p>
          <div id="xpBarContainer">
            <div id="xpBar"></div>
          </div>
          <p>Attack Power: <span id="heroAttack">1</span></p>
          <p>Health: <span id="heroHealth">100</span> / <span id="heroMaxHealth">100</span></p>
          <button id="healButton" title="Heal for 50 Gold">Heal (50 Gold)</button>
        </div>
        <div id="battleSection" style="margin-top: 15px;">
          <h3>Battle an Enemy <span id="enemyTypeLabel"></span></h3>
          <div id="enemyStatus">
            <p>Enemy HP: <span id="enemyHP">0</span></p>
            <div id="enemyHealthBarContainer">
              <div id="enemyHealthBar"></div>
            </div>
            <p>Reward: <span id="enemyReward">0</span> Gold, <span id="enemyXPReward">0</span> XP</p>
          </div>
          <button id="attackButton" title="Attack the enemy!">Attack!</button>
          <button id="specialAttackButton" title="Special Attack (Cooldown)">Special Attack!</button>
          <div id="specialCooldownBarContainer" style="margin-top:5px;">
            <div id="specialCooldownBar"></div>
          </div>
          <span id="specialCooldownDisplay"></span>
          <br>
          <button id="spawnEnemyButton" title="Spawn a new enemy">Spawn New Enemy</button>
        </div>
      </div>
    </div>
    <!-- Sidebar Column -->
    <div id="sidebarColumn">
      <!-- Prestige Section -->
      <div class="section" id="prestigeSection">
        <h2>Prestige</h2>
        <p>When your hero reaches Level 10, you can reset your progress for permanent benefits.</p>
        <p>Prestige Level: <span id="prestigeLevelDisplay">0</span></p>
        <p>Gold Multiplier: <span id="prestigeMultiplierDisplay">1.0</span>x</p>
        <p>Prestige Points: <span id="prestigePointsDisplay">0</span></p>
        <button id="prestigeButton" disabled title="Prestige Reset (requires Level 10)">Prestige Reset</button>
        <hr>
        <h3>Prestige Upgrades</h3>
        <p>Divine Blessing: Increases gold multiplier by 0.2 (Cost: 1 Prestige Point)</p>
        <button id="buyPrestigeUpgrade" title="Buy Divine Blessing">Buy Divine Blessing</button>
        <p>Additional Multiplier: <span id="bonusMultiplierDisplay">0.0</span></p>
      </div>
      <!-- Quest Section (Enhanced Branching Quest â€“ Improvement 8) -->
      <div class="section" id="questSection">
        <h2>Quests & Lore</h2>
        <p id="activeQuestText"></p>
        <ul id="questList"></ul>
        <!-- Enhanced Branching Quest: now three choices -->
        <div id="branchingQuest" style="display:none;">
          <p>How will you deal with the captured enemy?</p>
          <button id="mercifulChoice">Spare Him (Gain XP)</button>
          <button id="ruthlessChoice">Execute Him (Gain Gold)</button>
          <button id="interrogateChoice">Interrogate Him (Gain XP & Mystic Rune)</button>
        </div>
        <!-- Journal for lore entries -->
        <div id="journalSection">
          <h4>Journal</h4>
          <div id="journalEntries"></div>
        </div>
      </div>
      <!-- Skill Tree Section -->
      <div class="section" id="skillTreeSection">
        <h2>Skill Tree</h2>
        <p>Invest in your abilities. Choose your path: Combat, Resource, or Magic.
           (Purchased skills will disappear.)</p>
        <ul id="skillList">
          <!-- Combat Branch -->
          <li data-branch="combat" data-id="combat1">
            Power Strike (Increase hero attack by 2) â€“ Cost: 100 Gold 
            <button class="buySkillBtn">Buy</button>
          </li>
          <li data-branch="combat" data-id="combat2">
            Quick Reflex (Increase combo bonus by 0.2) â€“ Cost: 150 Gold 
            <button class="buySkillBtn">Buy</button>
          </li>
          <li data-branch="combat" data-id="combat3">
            Stunning Blow (Chance to stun enemy for 2s) â€“ Cost: 200 Gold 
            <button class="buySkillBtn">Buy</button>
          </li>
          <!-- Resource Branch -->
          <li data-branch="resource" data-id="resource1">
            Efficient Miner (Increase Gold Mine output by 20%) â€“ Cost: 120 Gold 
            <button class="buySkillBtn">Buy</button>
          </li>
          <li data-branch="resource" data-id="resource2">
            Merchant's Bargain (Reduce upgrade costs by 10%) â€“ Cost: 170 Gold 
            <button class="buySkillBtn">Buy</button>
          </li>
          <li data-branch="resource" data-id="resource3">
            Treasure Hunter (Increase relic drop chance) â€“ Cost: 220 Gold 
            <button class="buySkillBtn">Buy</button>
          </li>
          <!-- Magic Branch -->
          <li data-branch="magic" data-id="magic1">
            Arcane Mastery (Increase critical multiplier by 0.2) â€“ Cost: 130 Gold 
            <button class="buySkillBtn">Buy</button>
          </li>
        </ul>
      </div>
      <!-- Achievement Section -->
      <div class="section" id="achievementSection">
        <h2>Achievements</h2>
        <p>Track your milestones:</p>
        <ul id="achievementList"></ul>
      </div>
      <!-- Seasonal Event Section -->
      <div class="section" id="seasonalSection">
        <h2>Seasonal Event</h2>
        <p id="seasonalStatus">No event active.</p>
        <button id="activateEventButton" title="Activate a temporary festival with double gold">Activate Kingdom Festival (60s, double gold!)</button>
      </div>
      <!-- Leaderboard Section -->
      <div class="section" id="leaderboardSection">
        <h2>Leaderboard</h2>
        <p>Top High Scores:</p>
        <ul id="leaderboardList"></ul>
        <button id="shareScoreButton" title="Share your high score">Share Score</button>
        <button id="communityChallengeButton" title="Join Community Challenge">Join Community Challenge</button>
      </div>
      <!-- Mini-Game Section (Expanded Miniâ€‘Games â€“ Improvement 9) -->
      <div class="section" id="miniGameSection">
        <h2>Mini-Game</h2>
        <p>Try the Archery Challenge or the new Potion Mixing Challenge for bonus rewards!</p>
        <button id="startArchery">Start Archery Challenge</button>
        <button id="startPotionMixing">Start Potion Mixing</button>
      </div>
      <!-- Lore Section -->
      <div class="section" id="loreSection">
        <h2>Lore & World-Building</h2>
        <div id="staticLore">
          <p>Long ago in the Kingdom of Eldoria, mighty heroes and dastardly foes clashed for treasure and honor.</p>
        </div>
        <div id="dynamicLore"></div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      "use strict";
      // -------------------------
      // GLOBAL VARIABLES & STATE
      // -------------------------
      const saveVersion = 2;
      let gold = 0, goldPerClick = 1, baseGoldPerClickBonus = 0;
      let goldMineOwned = 0, goldMineCost = 10, clickUpgradeCost = 25;
      let critChance = 0.10, critMultiplier = 2, critUpgradeCost = 50;
      let autoClickerOwned = 0, autoClickerCost = 50;
      let blacksmithLevel = 0, blacksmithCost = 100;
      let guildLevel = 0, guildCost = 100;
      let mageTowerLevel = 0, mageTowerCost = 150;
      let hero = { level: 1, xp: 0, xpNeeded: 50, attack: 1, health: 100, maxHealth: 100 };
      let enemy = { maxHP: 0, currentHP: 0, rewardGold: 0, rewardXP: 0, level: 1, type: "Normal", 
                    dodgeChance: 0, counterDamage: 0, regen: 0, poison: false, poisonDamage: 0, poisonDuration: 0 };
      let specialAvailable = true, specialCooldownTime = 10, specialCooldownRemaining = 0;
      let prestigeLevel = 0, prestigePoints = 0, bonusMultiplier = 0.0;
      function currentGoldMultiplier() { return 1 + prestigeLevel * 0.1 + bonusMultiplier; }
      let highScore = 0;
      let enemyDefeatedCount = 0, specialAttackCount = 0;
      // Dynamic Story Events (Improvement 1 already done)
      let storyEventsTriggered = {};
      // Quests & Achievements
      const quests = [
        { id:1, desc: "Gather 100 Gold", lore: "The people of Eldoria hunger for wealth.", condition: () => gold >= 100, reward: () => { hero.xp += 10; }, completed: false },
        { id:2, desc: "Defeat 5 Enemies", lore: "Dark forces stir in the shadows.", condition: () => enemyDefeatedCount >= 5, reward: () => { gold += 20; }, completed: false },
        { id:3, desc: "Purchase 3 Gold Mines", lore: "Secure the wealth of the kingdom by expanding your mines.", condition: () => goldMineOwned >= 3, reward: () => { hero.attack += 1; }, completed: false },
        { id:4, desc: "Reach Level 5", lore: "Prove your valor on the battlefield.", condition: () => hero.level >= 5, reward: () => { gold += 50; }, completed: false },
        { id:5, desc: "Use Special Attack 3 times", lore: "Master the art of devastating blows.", condition: () => specialAttackCount >= 3, reward: () => { hero.xp += 20; }, completed: false },
        { id:6, desc: "Unlock a new enemy type", lore: "New foes arise as challenges intensify.", condition: () => enemy.type !== "Normal", reward: () => { gold += 30; }, completed: false },
        { id:7, desc: "Complete 5 quests", lore: "Your legend grows with each epic feat.", condition: () => quests.filter(q => q.completed).length >= 5, reward: () => { gold += 100; }, completed: false },
        { id:8, desc: "Merciful or Ruthless?", lore: "A captured enemy begs for mercy. Your choice will shape your destiny.", condition: () => false, reward: () => {}, completed: false }
      ];
      const achievements = [
        { id:1, desc: "First Click", condition: () => gold > 0, awarded: false },
        { id:2, desc: "Gold Hoarder (1,000 total earned)", condition: () => gold >= 1000, awarded: false },
        { id:3, desc: "Slayer (50 enemies defeated)", condition: () => enemyDefeatedCount >= 50, awarded: false },
        { id:4, desc: "Prestige Master (Prestige Level 5)", condition: () => prestigeLevel >= 5, awarded: false },
        { id:5, desc: "Quest Conqueror (Complete 5 quests)", condition: () => quests.filter(q => q.completed).length >= 5, awarded: false },
        { id:6, desc: "Herald's Blessing (Click a Royal Herald)", condition: () => clickedRoyalHerald, awarded: false }
      ];
      let clickedRoyalHerald = false;
      // Skill tree with prerequisites (Improvement 3 already integrated)
      const skills = {
        combat1: { purchased: false, cost: 100, effect: () => { hero.attack += 2; } },
        combat2: { purchased: false, cost: 150, prerequisite: "combat1", effect: () => { comboMultiplier += 0.2; } },
        combat3: { purchased: false, cost: 200, prerequisite: "combat2", effect: () => { hero.stunChance = 0.2; } },
        resource1: { purchased: false, cost: 120, effect: () => { resourceBoost *= 1.2; } },
        resource2: { purchased: false, cost: 170, prerequisite: "resource1", effect: () => { costReduction = 0.9; } },
        resource3: { purchased: false, cost: 220, prerequisite: "resource2", effect: () => { relicChance += 0.05; } },
        magic1: { purchased: false, cost: 130, effect: () => { critMultiplier += 0.2; } }
      };
      let resourceBoost = 1.0, costReduction = 1.0, relicChance = 0.0;
      // New resources:
      let relics = 0, mysticRunes = 0;
      // Settings:
      let difficultyMultiplier = 1, challengeMode = false, heroSpecialization = "Warrior";
      // Seasonal event:
      let eventActive = false, eventTimeRemaining = 0, eventInterval = null;
      let temporaryGoldBonus = 1;
      // Offline progress:
      let lastSaveTime = Date.now();
      // Leaderboard:
      let leaderboard = [];
      // Combo system:
      let lastAttackTime = 0, comboMultiplier = 1;
      const healCost = 50, healAmount = 20;
      // Auto clicker interval:
      let autoClickInterval = 3000;
      // Settings variables:
      let musicVolume = 0.3, sfxVolume = 1, muteSound = false;
      // Community Challenge:
      let communityChallengeActive = false;
      
      // -------------------------
      // DOM ELEMENTS
      // -------------------------
      const goldDisplay = document.getElementById("goldDisplay"),
            goldPerClickDisplay = document.getElementById("goldPerClickDisplay"),
            clickButton = document.getElementById("clickButton"),
            critChanceDisplay = document.getElementById("critChanceDisplay"),
            critMultiplierDisplay = document.getElementById("critMultiplierDisplay"),
            critUpgradeCostDisplay = document.getElementById("critUpgradeCostDisplay"),
            upgradeCritButton = document.getElementById("upgradeCrit");
      const buyGoldMineButton = document.getElementById("buyGoldMine"),
            goldMineCostDisplay = document.getElementById("goldMineCost"),
            goldMineOwnedDisplay = document.getElementById("goldMineOwned"),
            upgradeClickButton = document.getElementById("upgradeClick"),
            clickUpgradeCostDisplay = document.getElementById("clickUpgradeCost"),
            buyAutoClickerButton = document.getElementById("buyAutoClicker"),
            autoClickerCostDisplay = document.getElementById("autoClickerCost"),
            autoClickerOwnedDisplay = document.getElementById("autoClickerOwned"),
            hireBlacksmithButton = document.getElementById("hireBlacksmith"),
            blacksmithCostDisplay = document.getElementById("blacksmithCost"),
            blacksmithLevelDisplay = document.getElementById("blacksmithLevel");
      const guildCostDisplay = document.getElementById("guildCost"),
            guildLevelDisplay = document.getElementById("guildLevel"),
            mageTowerCostDisplay = document.getElementById("mageTowerCost"),
            mageTowerLevelDisplay = document.getElementById("mageTowerLevel");
      const heroLevelDisplay = document.getElementById("heroLevel"),
            heroXPDisplay = document.getElementById("heroXP"),
            heroXPNeededDisplay = document.getElementById("heroXPNeeded"),
            heroAttackDisplay = document.getElementById("heroAttack"),
            xpBar = document.getElementById("xpBar"),
            enemyHPDisplay = document.getElementById("enemyHP"),
            enemyRewardDisplay = document.getElementById("enemyReward"),
            enemyXPRewardDisplay = document.getElementById("enemyXPReward"),
            enemyHealthBar = document.getElementById("enemyHealthBar"),
            attackButton = document.getElementById("attackButton"),
            specialAttackButton = document.getElementById("specialAttackButton"),
            specialCooldownDisplay = document.getElementById("specialCooldownDisplay"),
            spawnEnemyButton = document.getElementById("spawnEnemyButton"),
            documentHeaderEnemyType = document.getElementById("enemyTypeLabel"),
            specialCooldownBar = document.getElementById("specialCooldownBar");
      const heroHealthDisplay = document.getElementById("heroHealth"),
            heroMaxHealthDisplay = document.getElementById("heroMaxHealth"),
            healButton = document.getElementById("healButton");
      const prestigeButton = document.getElementById("prestigeButton"),
            documentPrestigeLevel = document.getElementById("prestigeLevelDisplay"),
            documentPrestigeMultiplier = document.getElementById("prestigeMultiplierDisplay"),
            prestigePointsDisplay = document.getElementById("prestigePointsDisplay"),
            bonusMultiplierDisplay = document.getElementById("bonusMultiplierDisplay"),
            buyPrestigeUpgradeButton = document.getElementById("buyPrestigeUpgrade"),
            headerPrestigeLevel = document.getElementById("headerPrestigeLevel"),
            headerPrestigeMultiplier = document.getElementById("headerPrestigeMultiplier"),
            headerHighScore = document.getElementById("headerHighScore"),
            headerRelics = document.getElementById("headerRelics"),
            headerMysticRunes = document.getElementById("headerMysticRunes");
      const questListElem = document.getElementById("questList"),
            activeQuestText = document.getElementById("activeQuestText"),
            dynamicLoreContainer = document.getElementById("dynamicLore"),
            branchingQuestDiv = document.getElementById("branchingQuest"),
            journalEntriesDiv = document.getElementById("journalEntries");
      const skillListElem = document.getElementById("skillList");
      const achievementListElem = document.getElementById("achievementList");
      const seasonalStatusElem = document.getElementById("seasonalStatus"),
            activateEventButton = document.getElementById("activateEventButton");
      const leaderboardListElem = document.getElementById("leaderboardList"),
            shareScoreButton = document.getElementById("shareScoreButton"),
            communityChallengeButton = document.getElementById("communityChallengeButton");
      const startArcheryButton = document.getElementById("startArchery"),
            archeryModal = document.getElementById("archeryModal"),
            archeryTarget = document.getElementById("archeryTarget"),
            closeArcheryButton = document.getElementById("closeArchery");
      const startPotionMixingButton = document.getElementById("startPotionMixing"),
            potionModal = document.getElementById("potionModal"),
            closePotionButton = document.getElementById("closePotion");
      const notificationDiv = document.getElementById("notification");
      const settingsButton = document.getElementById("settingsButton"),
            settingsModal = document.getElementById("settingsModal"),
            musicVolumeSlider = document.getElementById("musicVolumeSlider"),
            sfxVolumeSlider = document.getElementById("sfxVolumeSlider"),
            muteToggle = document.getElementById("muteToggle"),
            difficultySelect = document.getElementById("difficultySelect"),
            challengeModeToggle = document.getElementById("challengeModeToggle"),
            specializationSelect = document.getElementById("specializationSelect"),
            closeSettings = document.getElementById("closeSettings");
      const tutorialOverlay = document.getElementById("tutorialOverlay"),
            dismissTutorial = document.getElementById("dismissTutorial");
      const qteButton = document.getElementById("qteButton");
      const backgroundMusic = document.getElementById("backgroundMusic"),
            clickSound = document.getElementById("clickSound"),
            levelUpSound = document.getElementById("levelUpSound"),
            enemyDefeatedSound = document.getElementById("enemyDefeatedSound"),
            upgradeSound = document.getElementById("upgradeSound"),
            poisonSound = document.getElementById("poisonSound"),
            qteSuccessSound = document.getElementById("qteSuccessSound");

      // -------------------------
      // UTILITY FUNCTIONS
      // -------------------------
      function getPassiveIncomeMultiplier() {
        return resourceBoost * (1 + guildLevel * 0.05);
      }
      function updateDisplays() {
        goldDisplay.textContent = Math.floor(gold);
        goldPerClickDisplay.textContent = goldPerClick + baseGoldPerClickBonus;
        critChanceDisplay.textContent = Math.floor(critChance * 100) + "%";
        critMultiplierDisplay.textContent = critMultiplier.toFixed(1) + "x";
        critUpgradeCostDisplay.textContent = critUpgradeCost;
        goldMineOwnedDisplay.textContent = goldMineOwned;
        goldMineCostDisplay.textContent = goldMineCost;
        clickUpgradeCostDisplay.textContent = clickUpgradeCost;
        autoClickerCostDisplay.textContent = autoClickerCost;
        autoClickerOwnedDisplay.textContent = autoClickerOwned;
        blacksmithCostDisplay.textContent = blacksmithCost;
        blacksmithLevelDisplay.textContent = blacksmithLevel;
        guildCostDisplay.textContent = guildCost;
        guildLevelDisplay.textContent = guildLevel;
        mageTowerCostDisplay.textContent = mageTowerCost;
        mageTowerLevelDisplay.textContent = mageTowerLevel;
        heroLevelDisplay.textContent = hero.level;
        heroXPDisplay.textContent = hero.xp;
        heroXPNeededDisplay.textContent = hero.xpNeeded;
        let xpPercent = (hero.xp / hero.xpNeeded) * 100;
        xpBar.style.width = xpPercent + "%";
        heroHealthDisplay.textContent = hero.health;
        heroMaxHealthDisplay.textContent = hero.maxHealth;
        enemyHPDisplay.textContent = enemy.currentHP < 0 ? 0 : enemy.currentHP;
        enemyRewardDisplay.textContent = enemy.rewardGold;
        enemyXPRewardDisplay.textContent = enemy.rewardXP;
        if (enemy.maxHP > 0) {
          let enemyHealthPercent = (enemy.currentHP / enemy.maxHP) * 100;
          enemyHealthBar.style.width = enemyHealthPercent + "%";
        } else {
          enemyHealthBar.style.width = "0%";
        }
        documentPrestigeLevel.textContent = prestigeLevel;
        documentPrestigeMultiplier.textContent = currentGoldMultiplier().toFixed(1);
        prestigePointsDisplay.textContent = prestigePoints;
        bonusMultiplierDisplay.textContent = bonusMultiplier.toFixed(1);
        headerPrestigeLevel.textContent = prestigeLevel;
        headerPrestigeMultiplier.textContent = currentGoldMultiplier().toFixed(1);
        headerHighScore.textContent = highScore;
        headerRelics.textContent = relics;
        headerMysticRunes.textContent = mysticRunes;
        updateQuestDisplay();
        updateSkillTree();
        updateAchievementDisplay();
        updateLeaderboard();
      }
      function showNotification(message, duration = 2000) {
        notificationDiv.textContent = message;
        notificationDiv.classList.add("show");
        setTimeout(() => { notificationDiv.classList.remove("show"); }, duration);
        if(navigator.vibrate) navigator.vibrate(100);
      }
      function createGoldFloat(amount, x, y) {
        const floatElem = document.createElement("span");
        floatElem.className = "gold-float";
        floatElem.textContent = "+" + Math.floor(amount);
        floatElem.style.left = x + "px";
        floatElem.style.top = y + "px";
        document.body.appendChild(floatElem);
        setTimeout(() => { floatElem.remove(); }, 1500);
      }
      function updateSpecialCooldownBar() {
        if(!specialAvailable) {
          let percent = ((specialCooldownTime - specialCooldownRemaining) / specialCooldownTime) * 100;
          specialCooldownBar.style.width = percent + "%";
          specialCooldownDisplay.textContent = "Cooldown: " + specialCooldownRemaining + "s";
        } else {
          specialCooldownBar.style.width = "100%";
          specialCooldownDisplay.textContent = "Ready!";
        }
      }
      
      // -------------------------
      // DYNAMIC STORY EVENTS (Already integrated in checkLevelUp)
      function triggerStoryEvent(eventText) {
        appendLore(eventText);
        showNotification(eventText, 4000);
      }
      
      // -------------------------
      // RANDOM WORLD EVENTS, ROYAL HERALD, DRAGON EVENT
      function triggerRandomEvent() {
        let r = Math.random();
        if(r < 0.3) {
          temporaryGoldBonus = 2;
          showNotification("Treasure Discovery! Gold earnings doubled for 30s!", 3000);
          setTimeout(() => { temporaryGoldBonus = 1; updateDisplays(); }, 30000);
        } else if(r < 0.6) {
          relics++;
          showNotification("Ancient Relic Found! You gained 1 relic.", 3000);
          updateDisplays();
        }
      }
      setInterval(() => { if(Math.random() < 0.2) triggerRandomEvent(); }, 60000);
      let royalHeraldExists = false;
      function spawnRoyalHerald() {
        if (royalHeraldExists) return;
        royalHeraldExists = true;
        const herald = document.createElement("div");
        herald.className = "royal-herald";
        herald.textContent = "Royal Herald! Click for Fortune!";
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        herald.style.left = Math.random() * (vw - 200) + "px";
        herald.style.top = Math.random() * (vh - 50) + "px";
        document.body.appendChild(herald);
        herald.addEventListener("click", function() {
          clickedRoyalHerald = true;
          let bonusType = Math.random();
          if (bonusType < 0.33) {
            let bonusGold = 500;
            gold += bonusGold;
            showNotification("Royal Herald grants you " + bonusGold + " bonus gold!");
          } else if (bonusType < 0.66) {
            let bonusXP = 50;
            hero.xp += bonusXP;
            showNotification("Royal Herald bestows " + bonusXP + " bonus XP!");
          } else {
            temporaryGoldBonus = 2;
            showNotification("Royal Heraldâ€™s Decree! Gold earnings doubled for 30s!");
            setTimeout(() => { temporaryGoldBonus = 1; updateDisplays(); }, 30000);
          }
          herald.remove();
          royalHeraldExists = false;
          updateDisplays();
        });
        setTimeout(() => { if(document.body.contains(herald)) { herald.remove(); royalHeraldExists = false; } }, 10000);
      }
      setInterval(() => { if(Math.random() < 0.3) spawnRoyalHerald(); }, 30000);
      let dragonEventActive = false;
      function spawnDragonEvent() {
        if(dragonEventActive) return;
        dragonEventActive = true;
        const dragon = document.createElement("div");
        dragon.className = "dragon-event";
        dragon.textContent = "Dragon's Rampage! Click to slay and earn huge rewards!";
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        dragon.style.left = Math.random() * (vw - 250) + "px";
        dragon.style.top = Math.random() * (vh - 50) + "px";
        document.body.appendChild(dragon);
        dragon.addEventListener("click", function() {
          let bonusGold = 1000;
          let bonusXP = 100;
          gold += bonusGold;
          hero.xp += bonusXP;
          showNotification("Dragon slain! +" + bonusGold + " Gold, +" + bonusXP + " XP!");
          dragon.remove();
          dragonEventActive = false;
          updateDisplays();
        });
        setTimeout(() => { if(document.body.contains(dragon)) { dragon.remove(); dragonEventActive = false; } }, 15000);
      }
      setInterval(() => { if(Math.random() < 0.1) spawnDragonEvent(); }, 45000);
      
      // -------------------------
      // QUEST FUNCTIONS & LORE
      function updateQuestDisplay() {
        questListElem.innerHTML = "";
        let activeQuest = null;
        quests.sort((a, b) => a.id - b.id);
        quests.forEach(q => {
          const li = document.createElement("li");
          li.textContent = q.desc + (q.completed ? " (Completed)" : "");
          if(!q.completed && !activeQuest && q.id !== 8) { activeQuest = q; }
          questListElem.appendChild(li);
        });
        activeQuestText.textContent = activeQuest ? "Current Quest: " + activeQuest.desc : "All quests completed!";
        const branchQuest = quests.find(q => q.id === 8 && !q.completed);
        branchingQuestDiv.style.display = branchQuest ? "block" : "none";
      }
      function appendLore(text) {
        const p = document.createElement("p");
        p.textContent = text;
        dynamicLoreContainer.appendChild(p);
        const jp = document.createElement("p");
        jp.textContent = text;
        journalEntriesDiv.appendChild(jp);
      }
      function checkQuests() {
        quests.forEach(q => {
          if(!q.completed && q.condition()) {
            q.completed = true;
            q.reward();
            showNotification("Quest completed: " + q.desc, 2500);
            appendLore(q.lore);
          }
        });
      }
      
      // -------------------------
      // ACHIEVEMENT FUNCTIONS
      function updateAchievementDisplay() {
        achievementListElem.innerHTML = "";
        achievements.forEach(a => {
          const li = document.createElement("li");
          li.textContent = a.desc + (a.awarded ? " (Achieved)" : "");
          achievementListElem.appendChild(li);
        });
      }
      function checkAchievements() {
        achievements.forEach(a => {
          if(!a.awarded && a.condition()) {
            a.awarded = true;
            showNotification("Achievement unlocked: " + a.desc, 2500);
          }
        });
      }
      
      // -------------------------
      // SKILL TREE FUNCTIONS (Advanced Skill Tree â€“ Improvement 3)
      let skillOrder = Object.keys(skills);
      function updateSkillTree() {
        const lis = document.querySelectorAll("#skillList li");
        lis.forEach(li => {
          let id = li.getAttribute("data-id");
          let skill = skills[id];
          if(skill.prerequisite && !skills[skill.prerequisite].purchased) {
            li.style.display = "none";
          } else {
            li.style.display = "list-item";
          }
        });
      }
      function updateSkillTreeDisplay() {
        skillListElem.innerHTML = "";
        skillOrder = Object.keys(skills);
        skillOrder.forEach((id, index) => {
          const skill = skills[id];
          const li = document.createElement("li");
          li.setAttribute("data-id", id);
          let displayName = skill.name ? skill.name : ("Skill " + (index + 1));
          li.innerHTML = displayName + " â€“ Cost: " + skill.cost + " Gold " +
                         "<button class='buySkillBtn' title='Buy " + displayName + "'>Buy</button>";
          if(skill.prerequisite && !skills[skill.prerequisite].purchased) {
            li.style.display = "none";
          }
          skillListElem.appendChild(li);
        });
      }
      document.querySelectorAll(".buySkillBtn").forEach(btn => {
        btn.addEventListener("click", function(e) {
          const li = e.target.parentElement;
          const skillId = li.getAttribute("data-id");
          if(skills[skillId].purchased) {
            showNotification("Skill already purchased!");
            return;
          }
          if(gold >= skills[skillId].cost) {
            gold -= skills[skillId].cost;
            skills[skillId].purchased = true;
            skills[skillId].effect();
            showNotification("Skill purchased: " + li.textContent, 2000);
            li.remove();
            updateDisplays();
          } else {
            showNotification("Not enough gold for this skill!");
          }
        });
      });
      
      // -------------------------
      // SETTINGS & TUTORIAL FUNCTIONS
      settingsButton.addEventListener("click", function() {
        settingsModal.style.display = "block";
        musicVolumeSlider.value = musicVolume;
        sfxVolumeSlider.value = sfxVolume;
        muteToggle.checked = muteSound;
        difficultySelect.value = difficultyMultiplier;
        challengeModeToggle.checked = challengeMode;
        specializationSelect.value = heroSpecialization;
      });
      closeSettings.addEventListener("click", function() {
        difficultyMultiplier = parseFloat(difficultySelect.value);
        challengeMode = challengeModeToggle.checked;
        heroSpecialization = specializationSelect.value;
        settingsModal.style.display = "none";
        showNotification("Settings updated.");
      });
      musicVolumeSlider.addEventListener("input", function() {
        musicVolume = parseFloat(this.value);
        backgroundMusic.volume = musicVolume;
      });
      sfxVolumeSlider.addEventListener("input", function() {
        sfxVolume = parseFloat(this.value);
      });
      muteToggle.addEventListener("change", function() {
        muteSound = this.checked;
        if(muteSound) { backgroundMusic.pause(); } else { backgroundMusic.play(); }
      });
      shareScoreButton.addEventListener("click", function() {
        if(navigator.share) {
          navigator.share({
            title: "Medieval Idle Adventure",
            text: "My high score is " + highScore + " gold, " + relics + " relics, and " + mysticRunes + " Mystic Runes!",
          }).then(() => console.log("Score shared!"))
            .catch(err => console.error("Error sharing:", err));
        } else {
          showNotification("Sharing not supported on this browser.");
        }
      });
      dismissTutorial.addEventListener("click", function() {
        tutorialOverlay.style.display = "none";
        localStorage.setItem("tutorialSeen", "true");
        backgroundMusic.play().catch(err => console.log("Music play error:", err));
      });
      communityChallengeButton.addEventListener("click", function() {
        if(!communityChallengeActive) {
          communityChallengeActive = true;
          showNotification("Community Challenge started! Earn bonus rewards for 60s!");
          setTimeout(() => {
            communityChallengeActive = false;
            let bonus = 500;
            gold += bonus;
            showNotification("Community Challenge completed! You earned " + bonus + " bonus gold!");
            updateDisplays();
          }, 60000);
        } else {
          showNotification("Community Challenge already active!");
        }
      });
      startArcheryButton.addEventListener("click", function() {
        archeryModal.style.display = "block";
        archeryTarget.style.left = Math.random() * 150 + "px";
        archeryTarget.style.top = Math.random() * 50 + "px";
      });
      archeryTarget.addEventListener("click", function() {
        let bonusGold = 300;
        let bonusRunes = 2;
        gold += bonusGold;
        mysticRunes += bonusRunes;
        showNotification("Archery hit! +" + bonusGold + " Gold, +" + bonusRunes + " Mystic Runes!");
        archeryModal.style.display = "none";
        updateDisplays();
      });
      closeArcheryButton.addEventListener("click", function() {
        archeryModal.style.display = "none";
      });
      // New Potion Mixing Mini-Game (Improvement 9)
      startPotionMixingButton.addEventListener("click", function() {
        potionModal.style.display = "block";
        // Reset any previous state if needed.
        selectedIngredients = [];
      });
      closePotionButton.addEventListener("click", function() {
        potionModal.style.display = "none";
        selectedIngredients = [];
      });
      let selectedIngredients = [];
      document.querySelectorAll(".potionBtn").forEach(btn => {
        btn.addEventListener("click", function() {
          let ingredient = btn.getAttribute("data-ingredient");
          selectedIngredients.push(ingredient);
          // Check if three ingredients have been selected.
          if(selectedIngredients.length === 3) {
            let correctSequence = ["Herb", "Mushroom", "Crystal"];
            if(JSON.stringify(selectedIngredients) === JSON.stringify(correctSequence)) {
              let bonusGold = 500;
              let bonusXP = 50;
              gold += bonusGold;
              hero.xp += bonusXP;
              showNotification("Potion mixed perfectly! +" + bonusGold + " Gold and +" + bonusXP + " XP!");
            } else {
              showNotification("Potion mixing failed! The ingredients were not in the correct order.", 2500);
            }
            selectedIngredients = [];
            potionModal.style.display = "none";
            updateDisplays();
          }
        });
      });
      
      // Enhanced Branching Quest (Improvement 8)
      document.getElementById("mercifulChoice").addEventListener("click", function() {
        let bonusXP = 100;
        hero.xp += bonusXP;
        showNotification("You chose mercy! +" + bonusXP + " XP.");
        const quest = quests.find(q => q.id === 8);
        if(quest) { quest.completed = true; appendLore("You chose mercy, showing compassion in battle."); }
        branchingQuestDiv.style.display = "none";
        updateDisplays();
      });
      document.getElementById("ruthlessChoice").addEventListener("click", function() {
        let bonusGold = 200;
        gold += bonusGold;
        showNotification("You showed no mercy! +" + bonusGold + " Gold.");
        const quest = quests.find(q => q.id === 8);
        if(quest) { quest.completed = true; appendLore("You chose ruthlessness, a dark path to power."); }
        branchingQuestDiv.style.display = "none";
        updateDisplays();
      });
      document.getElementById("interrogateChoice").addEventListener("click", function() {
        let bonusXP = 75;
        let bonusRune = 1;
        hero.xp += bonusXP;
        mysticRunes += bonusRune;
        showNotification("You interrogated the captive! +" + bonusXP + " XP and +" + bonusRune + " Mystic Rune gained!");
        const quest = quests.find(q => q.id === 8);
        if(quest) { quest.completed = true; appendLore("You interrogated the enemy and learned valuable secrets."); }
        branchingQuestDiv.style.display = "none";
        updateDisplays();
      });
      
      // -------------------------
      // ENEMY SPAWNING (Enhanced Enemy Variety and AI â€“ Improvement 4)
      function spawnEnemy() {
        enemy.level = hero.level;
        let r = Math.random();
        if(r < 0.15) {
          enemy.type = "Poisonous";
          enemy.maxHP = Math.floor((20 + enemy.level * 10) * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.5);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 1.5);
          enemy.poison = true;
          enemy.poisonDamage = enemy.level * 2;
          enemy.poisonDuration = 3;
          documentHeaderEnemyType.textContent = "(Poisonous)";
        } else if(r < 0.20) {
          enemy.type = "Boss";
          enemy.maxHP = ((20 + enemy.level * 10) * 3) * difficultyMultiplier * (challengeMode ? 1.2 : 1);
          enemy.rewardGold = ((5 + enemy.level * 2) * 3);
          enemy.rewardXP = ((10 + enemy.level * 3) * 3);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 3;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Boss)";
        } else if(r < 0.30) {
          enemy.type = "Armored";
          enemy.maxHP = Math.floor((20 + enemy.level * 10) * 1.5 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.2);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 0.8);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Armored)";
        } else if(r < 0.40) {
          enemy.type = "Agile";
          enemy.maxHP = (20 + enemy.level * 10) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0.3;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Agile)";
        } else if(r < 0.45) {
          enemy.type = "Shielded"; // New enemy type: Shielded
          enemy.maxHP = Math.floor((20 + enemy.level * 10) * difficultyMultiplier);
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          enemy.shieldReduction = 0.5; // 50% damage reduction
          documentHeaderEnemyType.textContent = "(Shielded)";
        } else if(r < 0.55) {
          enemy.type = "Regenerator";
          enemy.maxHP = Math.floor((20 + enemy.level * 10) * 1.2 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.1);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 1.1);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = Math.floor(enemy.maxHP * 0.02);
          documentHeaderEnemyType.textContent = "(Regenerator)";
        } else {
          enemy.type = "Normal";
          enemy.maxHP = (20 + enemy.level * 10) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "";
        }
        enemy.currentHP = enemy.maxHP;
        updateDisplays();
      }
      
      // -------------------------
      // LEVEL-UP & BATTLE FUNCTIONS
      function checkLevelUp() {
        while(hero.xp >= hero.xpNeeded) {
          hero.xp -= hero.xpNeeded;
          hero.level++;
          hero.attack++;
          hero.maxHealth += 20;
          hero.health = hero.maxHealth;
          hero.xpNeeded = Math.floor(hero.xpNeeded * 1.5);
          showNotification("Level Up! You are now level " + hero.level + "!", 2500);
          if(!muteSound) levelUpSound.play();
          if(heroSpecialization === "Warrior") {
            hero.attack += 1;
          } else if(heroSpecialization === "Merchant") {
            baseGoldPerClickBonus += 1;
          } else if(heroSpecialization === "Mage") {
            critMultiplier += 0.1;
          }
          // Dynamic Story Events are triggered in checkLevelUp (see earlier)
          updateDisplays();
          if(hero.level >= 10) prestigeButton.disabled = false;
        }
      }
      function applyPoisonEffect() {
        if(enemy.poison) {
          let poisonInterval = setInterval(() => {
            hero.health -= enemy.poisonDamage;
            updateDisplays();
            if(hero.health <= 0) {
              hero.health = 0;
              showNotification("You died from poison! Prestige to reset.", 4000);
              attackButton.disabled = true;
              specialAttackButton.disabled = true;
              clearInterval(poisonInterval);
            }
          }, 1000);
          setTimeout(() => { clearInterval(poisonInterval); }, enemy.poisonDuration * 1000);
          if(!muteSound) poisonSound.play();
        }
      }
      let qteActive = false;
      function triggerQTE() {
        if(qteActive) return;
        qteActive = true;
        qteButton.style.display = "block";
        setTimeout(() => { qteActive = false; qteButton.style.display = "none"; }, 2000);
      }
      qteButton.addEventListener("click", function() {
        if(qteActive) {
          comboMultiplier += 0.5;
          showNotification("Quick Strike! Combo increased!", 1500);
          if(!muteSound) qteSuccessSound.play();
          qteActive = false;
          qteButton.style.display = "none";
        }
      });
      
      // -------------------------
      // SAVE/LOAD & OFFLINE PROGRESS
      function saveGame() {
        try {
          const state = {
            saveVersion,
            gold, goldPerClick, baseGoldPerClickBonus, goldMineOwned, goldMineCost, clickUpgradeCost,
            critChance, critMultiplier, critUpgradeCost,
            autoClickerOwned, autoClickerCost, blacksmithLevel, blacksmithCost,
            guildLevel, guildCost, mageTowerLevel, mageTowerCost,
            hero, enemyDefeatedCount, specialAttackCount,
            prestigeLevel, prestigePoints, bonusMultiplier,
            highScore, resourceBoost, costReduction, relics, mysticRunes,
            quests, achievements, skills,
            lastSaveTime: Date.now(),
            leaderboard,
            heroSpecialization
          };
          localStorage.setItem("medievalIdleSave", JSON.stringify(state));
        } catch(e) {
          console.error("Error saving game:", e);
        }
      }
      function loadGame() {
        try {
          const stateStr = localStorage.getItem("medievalIdleSave");
          if(stateStr) {
            const state = JSON.parse(stateStr);
            if(state.saveVersion !== saveVersion) {
              console.warn("Save version mismatch â€“ starting fresh.");
              return;
            }
            gold = state.gold; goldPerClick = state.goldPerClick; baseGoldPerClickBonus = state.baseGoldPerClickBonus;
            goldMineOwned = state.goldMineOwned; goldMineCost = state.goldMineCost; clickUpgradeCost = state.clickUpgradeCost;
            critChance = state.critChance; critMultiplier = state.critMultiplier; critUpgradeCost = state.critUpgradeCost;
            autoClickerOwned = state.autoClickerOwned; autoClickerCost = state.autoClickerCost;
            blacksmithLevel = state.blacksmithLevel; blacksmithCost = state.blacksmithCost;
            guildLevel = state.guildLevel; guildCost = state.guildCost;
            mageTowerLevel = state.mageTowerLevel; mageTowerCost = state.mageTowerCost;
            hero = state.hero; enemyDefeatedCount = state.enemyDefeatedCount; specialAttackCount = state.specialAttackCount;
            prestigeLevel = state.prestigeLevel; prestigePoints = state.prestigePoints; bonusMultiplier = state.bonusMultiplier;
            highScore = state.highScore; resourceBoost = state.resourceBoost; costReduction = state.costReduction;
            relics = state.relics; mysticRunes = state.mysticRunes;
            leaderboard = state.leaderboard || [];
            heroSpecialization = state.heroSpecialization || "Warrior";
            lastSaveTime = state.lastSaveTime;
            const offlineSeconds = Math.floor((Date.now() - lastSaveTime) / 1000);
            const offlineGold = offlineSeconds * (goldMineOwned + autoClickerOwned * goldPerClick) * currentGoldMultiplier() * getPassiveIncomeMultiplier();
            gold += offlineGold;
            showNotification("Welcome back! You earned " + Math.floor(offlineGold) + " gold offline.", 3000);
          }
        } catch(e) {
          console.error("Error loading game:", e);
        }
      }
      window.addEventListener("beforeunload", saveGame);
      window.addEventListener("load", () => {
        loadGame();
        updateDisplays();
        spawnEnemy();
        backgroundMusic.volume = musicVolume;
        backgroundMusic.play().catch(err => console.log("Autoplay prevented", err));
        autoClickerLoop();
        if(!localStorage.getItem("tutorialSeen")) {
          tutorialOverlay.style.display = "flex";
        }
      });
      
      // -------------------------
      // AUTO CLICKER LOOP
      function autoClickerLoop() {
        setTimeout(function() {
          if(autoClickerOwned > 0) {
            gold += autoClickerOwned * goldPerClick * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
            updateDisplays();
          }
          autoClickerLoop();
        }, autoClickInterval);
      }
      
      // -------------------------
      // GAME LOOP
      function gameLoop() {
        updateSpecialCooldownBar();
        if(enemy.type === "Regenerator" && enemy.currentHP > 0) {
          enemy.currentHP = Math.min(enemy.currentHP + enemy.regen * 0.016, enemy.maxHP);
          updateDisplays();
        }
        requestAnimationFrame(gameLoop);
      }
      gameLoop();
      
      // -------------------------
      // EVENT LISTENERS & GAMEPLAY
      clickButton.addEventListener("click", function(e) {
        if(!muteSound) clickSound.play();
        let earned = goldPerClick + baseGoldPerClickBonus;
        let goldEarned = earned;
        if(Math.random() < critChance) {
          goldEarned *= critMultiplier;
          showNotification("Critical Strike! +" + Math.floor(goldEarned * currentGoldMultiplier() * temporaryGoldBonus) + " Gold", 1500);
        }
        const totalGold = goldEarned * currentGoldMultiplier() * temporaryGoldBonus;
        gold += totalGold;
        createGoldFloat(totalGold, e.clientX, e.clientY);
        updateDisplays();
        checkAchievements();
        checkQuests();
      });
      upgradeCritButton.addEventListener("click", function() {
        if(gold >= critUpgradeCost) {
          gold -= critUpgradeCost;
          critChance += 0.05;
          critUpgradeCost = Math.floor(critUpgradeCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade Critical Strike!"); }
      });
      buyGoldMineButton.addEventListener("click", function() {
        if(gold >= goldMineCost) {
          gold -= goldMineCost;
          goldMineOwned++;
          goldMineCost = Math.floor(goldMineCost * 1.15);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
          checkQuests();
        } else { showNotification("Not enough gold for Gold Mine!"); }
      });
      upgradeClickButton.addEventListener("click", function() {
        if(gold >= clickUpgradeCost) {
          gold -= clickUpgradeCost;
          goldPerClick++;
          clickUpgradeCost = Math.floor(clickUpgradeCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade click power!"); }
      });
      buyAutoClickerButton.addEventListener("click", function() {
        if(gold >= autoClickerCost) {
          gold -= autoClickerCost;
          autoClickerOwned++;
          autoClickerCost = Math.floor(autoClickerCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold for Auto Clicker!"); }
      });
      hireBlacksmithButton.addEventListener("click", function() {
        if(gold >= blacksmithCost) {
          gold -= blacksmithCost;
          blacksmithLevel++;
          hero.attack += 1;
          blacksmithCost = Math.floor(blacksmithCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to hire Blacksmith!"); }
      });
      document.getElementById("buyGuild").addEventListener("click", function() {
        if(gold >= guildCost) {
          gold -= guildCost;
          guildLevel++;
          guildCost = Math.floor(guildCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Adventurer's Guild upgraded! Passive income increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Adventurer's Guild!"); }
      });
      document.getElementById("buyMageTower").addEventListener("click", function() {
        if(gold >= mageTowerCost) {
          gold -= mageTowerCost;
          mageTowerLevel++;
          mageTowerCost = Math.floor(mageTowerCost * 1.4);
          critMultiplier += 0.1;
          if(!muteSound) upgradeSound.play();
          showNotification("Mage Tower built! Critical multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Mage Tower!"); }
      });
      healButton.addEventListener("click", function() {
        if(gold >= healCost) {
          gold -= healCost;
          hero.health = Math.min(hero.health + healAmount, hero.maxHealth);
          showNotification("Healed for " + healAmount + " HP!");
          updateDisplays();
        } else { showNotification("Not enough gold to heal!"); }
      });
      setInterval(function() {
        gold += goldMineOwned * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
        updateDisplays();
      }, 1000);
      attackButton.addEventListener("click", function() {
        if(enemy.currentHP > 0) {
          const currentTime = Date.now();
          if(currentTime - lastAttackTime < 2000) {
            comboMultiplier += 0.1;
          } else {
            comboMultiplier = 1;
          }
          lastAttackTime = currentTime;
          let damage = hero.attack * comboMultiplier;
          // Improvement 4: if enemy is Shielded, reduce damage
          if(enemy.type === "Shielded") {
            let originalDamage = damage;
            damage = Math.floor(damage * (1 - enemy.shieldReduction));
            showNotification("Enemy's shield absorbed " + (originalDamage - damage) + " damage!");
          }
          if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance) {
            showNotification("Enemy dodged your attack!");
          } else {
            enemy.currentHP -= damage;
            enemyHealthBar.classList.add("enemy-hit");
            setTimeout(() => { enemyHealthBar.classList.remove("enemy-hit"); }, 300);
            if(comboMultiplier > 1) {
              showNotification("Combo x" + comboMultiplier.toFixed(1) + " for " + Math.floor(damage) + " damage!");
            }
          }
          if(enemy.type === "Poisonous") {
            applyPoisonEffect();
          }
          if(Math.random() < 0.3) { triggerQTE(); }
          if(enemy.currentHP > 0 && Math.random() < 0.2) {
            let counterDmg = enemy.counterDamage;
            hero.health -= counterDmg;
            showNotification("Enemy counterattacked for " + counterDmg + " damage!");
            if(hero.health <= 0) {
              hero.health = 0;
              showNotification("You died! Prestige to reset.", 4000);
              attackButton.disabled = true;
              specialAttackButton.disabled = true;
              return;
            }
          }
          if(enemy.currentHP <= 0) {
            if(!muteSound) enemyDefeatedSound.play();
            enemyDefeatedCount++;
            if(enemy.type === "Boss") relics++;
            gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
            hero.xp += enemy.rewardXP;
            showNotification("Enemy defeated! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
            spawnEnemy();
            checkLevelUp();
          }
          updateDisplays();
          checkQuests();
          checkAchievements();
        } else { showNotification("Spawn an enemy first!"); }
      });
      specialAttackButton.addEventListener("click", function() {
        if(!specialAvailable) { showNotification("Special Attack is on cooldown!"); return; }
        if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance/2) {
          showNotification("Enemy evaded your Special Attack!");
        } else {
          enemy.currentHP -= hero.attack * 3;
          specialAttackCount++;
          showNotification("Special Attack dealt " + (hero.attack * 3) + " damage!");
        }
        if(enemy.currentHP <= 0) {
          if(!muteSound) enemyDefeatedSound.play();
          enemyDefeatedCount++;
          gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
          hero.xp += enemy.rewardXP;
          showNotification("Enemy defeated with Special Attack! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
          spawnEnemy();
          checkLevelUp();
        }
        updateDisplays();
        specialAvailable = false;
        specialAttackButton.disabled = true;
        specialCooldownRemaining = specialCooldownTime;
      });
      setInterval(function(){
        if(!specialAvailable && specialCooldownRemaining > 0) {
          specialCooldownRemaining--;
          if(specialCooldownRemaining <= 0) {
            specialAvailable = true;
            specialAttackButton.disabled = false;
          }
        }
      }, 1000);
      spawnEnemyButton.addEventListener("click", spawnEnemy);
      prestigeButton.addEventListener("click", function() {
        if(hero.level < 10) { showNotification("You need to be at least Level 10 to Prestige!"); return; }
        prestigeLevel++;
        prestigePoints++;
        showNotification("Prestige Activated! Gold Multiplier is now " + currentGoldMultiplier().toFixed(1) + "x", 3000);
        if(gold > highScore) highScore = gold;
        leaderboard.push({ name: "Hero", score: gold });
        gold = 0; goldPerClick = 1; goldMineOwned = 0; goldMineCost = 10; clickUpgradeCost = 25;
        critChance = 0.10; critMultiplier = 2; critUpgradeCost = 50;
        autoClickerOwned = 0; autoClickerCost = 50;
        blacksmithLevel = 0; blacksmithCost = 100;
        guildLevel = 0; guildCost = 100;
        mageTowerLevel = 0; mageTowerCost = 150;
        hero = { level: 1, xp: 0, xpNeeded: 50, attack: 1, health: 100, maxHealth: 100 };
        spawnEnemy();
        updateDisplays();
        prestigeButton.disabled = true;
        attackButton.disabled = false;
        specialAttackButton.disabled = false;
      });
      buyPrestigeUpgradeButton.addEventListener("click", function() {
        if(prestigePoints > 0) {
          prestigePoints--;
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Divine Blessing purchased! Bonus multiplier increased.", 2500);
          updateDisplays();
        } else {
          showNotification("Not enough Prestige Points!");
        }
      });
      setInterval(() => { checkQuests(); checkAchievements(); }, 2000);
      function updateLeaderboard() {
        leaderboardListElem.innerHTML = "";
        let sorted = leaderboard.sort((a, b) => b.score - a.score).slice(0, 5);
        sorted.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = entry.name + ": " + Math.floor(entry.score);
          leaderboardListElem.appendChild(li);
        });
      }
      
      // -------------------------
      // END OF EVENT LISTENERS
    })();
  </script>
</body>
</html>
