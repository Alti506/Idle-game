<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- Mobile responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medieval Idle Adventure â€“ Ultimate Edition</title>
  <!-- Google Fonts for a medieval look -->
  <link href="https://fonts.googleapis.com/css?family=Cinzel:400,700|MedievalSharp" rel="stylesheet">
  <style>
    /* Global styles */
    body {
      font-family: 'Cinzel', serif;
      background: url("https://www.transparenttextures.com/patterns/paper.png");
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: #8b4513;
      color: #fff;
      padding: 20px;
      text-align: center;
      font-family: 'MedievalSharp', cursive;
      font-size: 2.5em;
      text-shadow: 2px 2px #000;
      border-bottom: 3px solid #5a2d0c;
      position: relative;
    }
    #headerExtras {
      font-size: 0.6em;
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    /* Notification */
    #notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(139,69,19,0.9);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s ease, transform 0.5s ease;
      z-index: 2000;
    }
    #notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    /* Twoâ€‘column layout */
    #container {
      display: flex;
      gap: 20px;
      padding: 20px;
      flex-wrap: wrap;
    }
    #mainColumn {
      flex: 2;
      min-width: 300px;
    }
    #sidebarColumn {
      flex: 1;
      min-width: 280px;
    }
    /* Section styling */
    .section {
      border: 2px solid #8b4513;
      border-radius: 8px;
      padding: 20px;
      background: #fffaf0;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;
    }
    .section:hover {
      transform: scale(1.02);
    }
    h2, h3 {
      margin-top: 0;
      font-family: 'MedievalSharp', cursive;
      color: #8b4513;
    }
    button {
      padding: 10px 20px;
      background: #8b4513;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
      font-size: 1em;
      transition: background 0.3s, transform 0.1s;
    }
    button:hover {
      background: #a0522d;
    }
    button:active {
      transform: scale(0.98);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status p { margin: 5px 0; }
    /* Progress bars */
    #xpBarContainer, #enemyHealthBarContainer, #specialCooldownBarContainer {
      width: 100%;
      background: #ccc;
      border: 1px solid #8b4513;
      height: 20px;
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
    }
    #xpBar, #enemyHealthBar, #specialCooldownBar {
      height: 100%;
      width: 0%;
      transition: width 0.5s;
    }
    #xpBar { background: #ffd700; }
    #enemyHealthBar { background: #ff4500; }
    #specialCooldownBar { background: #00bfff; }
    /* Floating gold */
    .gold-float {
      position: absolute;
      font-size: 20px;
      font-weight: bold;
      color: gold;
      pointer-events: none;
      z-index: 1000;
      animation: floatUp 1.5s ease-out forwards;
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0px); }
      100% { opacity: 0; transform: translateY(-50px); }
    }
    /* Royal Herald (Golden Cookie analogue) */
    .royal-herald {
      position: fixed;
      background: gold;
      color: black;
      padding: 10px 20px;
      border: 2px solid darkgoldenrod;
      border-radius: 8px;
      font-family: 'MedievalSharp', cursive;
      font-size: 1.2em;
      z-index: 3000;
      cursor: pointer;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* Quest list */
    #questList li {
      list-style: none;
      margin: 5px 0;
    }
    #questList li.completed {
      text-decoration: line-through;
      color: green;
      animation: fadeIn 1s;
    }
    /* Seasonal event */
    #seasonalStatus {
      font-weight: bold;
      color: darkred;
    }
    /* Leaderboard */
    #leaderboardList {
      list-style-type: none;
      padding: 0;
    }
    #leaderboardList li {
      padding: 4px;
      border-bottom: 1px solid #ccc;
    }
    /* Statistics panel */
    #statisticsPanel p {
      margin: 5px 0;
    }
    /* Event Log */
    #eventLog {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      background: #fff;
      font-size: 0.9em;
      margin-top: 10px;
    }
    /* Tutorial overlay */
    #tutorialOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 3000;
      padding: 20px;
    }
    #tutorialOverlay button {
      margin-top: 20px;
    }
    /* Settings modal */
    #settingsModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fffaf0;
      border: 2px solid #8b4513;
      padding: 20px;
      z-index: 3000;
      display: none;
      width: 300px;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
    }
    #settingsModal h3 {
      margin-top: 0;
      text-align: center;
    }
    #settingsModal label {
      display: block;
      margin-top: 10px;
    }
    /* Miniâ€‘Game modal */
    #miniGameModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fffaf0;
      border: 2px solid #8b4513;
      padding: 20px;
      z-index: 3000;
      display: none;
      width: 300px;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
      text-align: center;
    }
    /* Settings button */
    #settingsButton {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      font-size: 0.8em;
      background: #a0522d;
    }
  </style>
</head>
<body>
  <!-- Audio elements -->
  <audio id="backgroundMusic" src="background-music.mp3" loop></audio>
  <audio id="clickSound" src="click.mp3"></audio>
  <audio id="levelUpSound" src="levelup.mp3"></audio>
  <audio id="enemyDefeatedSound" src="enemy-defeated.mp3"></audio>
  <audio id="upgradeSound" src="upgrade.mp3"></audio>

  <!-- Settings Button -->
  <button id="settingsButton" title="Open Settings">Settings</button>

  <header>
    Medieval Idle Adventure â€“ Ultimate Edition
    <div id="headerExtras">
      <div>Prestige Level: <span id="headerPrestigeLevel">0</span></div>
      <div>Gold Multiplier: <span id="headerPrestigeMultiplier">1.0</span>x</div>
      <div>High Score: <span id="headerHighScore">0</span></div>
      <div>Relics: <span id="headerRelics">0</span></div>
    </div>
  </header>

  <!-- Notification -->
  <div id="notification"></div>

  <!-- Tutorial Overlay -->
  <div id="tutorialOverlay" style="display:none;">
    <h2>Welcome to Medieval Idle Adventure!</h2>
    <p>
      Tap the treasure chest to gather gold, upgrade your abilities, battle foes, complete daily challenges, and uncover ancient lore.
      Enjoy miniâ€‘games, a robust skill tree, achievements, and more!
    </p>
    <button id="dismissTutorial">Got It!</button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal">
    <h3>Settings</h3>
    <label>
      Music Volume:
      <input type="range" id="musicVolumeSlider" min="0" max="1" step="0.05">
    </label>
    <label>
      SFX Volume:
      <input type="range" id="sfxVolumeSlider" min="0" max="1" step="0.05">
    </label>
    <label>
      <input type="checkbox" id="muteToggle"> Mute All Sounds
    </label>
    <label>
      Difficulty:
      <select id="difficultySelect">
        <option value="0.8">Easy</option>
        <option value="1" selected>Normal</option>
        <option value="1.2">Hard</option>
      </select>
    </label>
    <label>
      <input type="checkbox" id="challengeModeToggle"> Enable Challenge Mode
    </label>
    <button id="closeSettings">Close</button>
  </div>

  <!-- Miniâ€‘Game Modal -->
  <div id="miniGameModal">
    <h3>Miniâ€‘Game Challenge</h3>
    <p>Click the button as many times as you can in 10 seconds!</p>
    <p>Clicks: <span id="miniGameClicks">0</span></p>
    <button id="miniGameButton">Click Me!</button>
    <p id="miniGameTimer">Time left: 10s</p>
    <button id="endMiniGameButton" style="display:none;">Finish</button>
  </div>

  <!-- Container with two columns -->
  <div id="container">
    <!-- Main Column -->
    <div id="mainColumn">
      <!-- Clicker Section -->
      <div class="section" id="clickerSection">
        <h2>Clicker</h2>
        <p>Tap the treasure chest to gather gold!</p>
        <button id="clickButton" title="Click to earn gold!">ðŸ’° Click Me!</button>
        <div class="status">
          <p>Gold: <span id="goldDisplay">0</span></p>
          <p>Gold Per Click: <span id="goldPerClickDisplay">1</span></p>
          <p>Critical Strike Chance: <span id="critChanceDisplay">10%</span></p>
          <p>Critical Multiplier: <span id="critMultiplierDisplay">2.0x</span></p>
          <p>
            Upgrade Critical Strike (Increase chance by 5%): Cost:
            <span id="critUpgradeCostDisplay">50</span> Gold
          </p>
          <button id="upgradeCrit" title="Increase crit chance by 5%">Upgrade Critical Strike</button>
        </div>
      </div>

      <!-- Resource Management Section -->
      <div class="section" id="resourceSection">
        <h2>Resource Management</h2>
        <p>Purchase buildings and upgrades to generate gold automatically.</p>
        <!-- Gold Mine -->
        <div>
          <p><strong>Gold Mine</strong> (Generates 1 gold per second)</p>
          <p>Cost: <span id="goldMineCost">10</span> Gold</p>
          <button id="buyGoldMine" title="Purchase a Gold Mine">Buy Gold Mine</button>
          <p>Owned: <span id="goldMineOwned">0</span></p>
        </div>
        <!-- Upgrade Click -->
        <div style="margin-top: 10px;">
          <p><strong>Upgrade Click Power</strong> (Increase gold per click by 1)</p>
          <p>Cost: <span id="clickUpgradeCost">25</span> Gold</p>
          <button id="upgradeClick" title="Increase click gold">Upgrade Click</button>
        </div>
        <!-- Auto Clicker -->
        <div style="margin-top: 10px;">
          <p><strong>Auto Clicker</strong> (Automatically clicks using your heroes)</p>
          <p>Cost: <span id="autoClickerCost">50</span> Gold</p>
          <button id="buyAutoClicker" title="Buy an Auto Clicker">Buy Auto Clicker</button>
          <p>Owned: <span id="autoClickerOwned">0</span></p>
        </div>
        <!-- Blacksmith -->
        <div style="margin-top: 10px;">
          <p><strong>Blacksmith</strong> (Increase hero attack by 1)</p>
          <p>Cost: <span id="blacksmithCost">100</span> Gold</p>
          <button id="hireBlacksmith" title="Hire a Blacksmith">Hire Blacksmith</button>
          <p>Level: <span id="blacksmithLevel">0</span></p>
        </div>
        <!-- Adventurer's Guild -->
        <div style="margin-top: 10px;">
          <p><strong>Adventurer's Guild</strong> (Increase passive income by 5% per level)</p>
          <p>Cost: <span id="guildCost">100</span> Gold</p>
          <button id="buyGuild" title="Upgrade Adventurer's Guild">Buy Adventurer's Guild</button>
          <p>Level: <span id="guildLevel">0</span></p>
        </div>
        <!-- Mage Tower -->
        <div style="margin-top: 10px;">
          <p><strong>Mage Tower</strong> (Increase critical multiplier by 0.1 per level)</p>
          <p>Cost: <span id="mageTowerCost">150</span> Gold</p>
          <button id="buyMageTower" title="Buy Mage Tower">Buy Mage Tower</button>
          <p>Level: <span id="mageTowerLevel">0</span></p>
        </div>
        <!-- New Buildings -->
        <div style="margin-top: 10px;">
          <p><strong>Barracks</strong> (Increases hero attack by 3 per Barracks)</p>
          <p>Cost: <span id="barracksCost">200</span> Gold</p>
          <button id="buyBarracks" title="Buy Barracks">Buy Barracks</button>
          <p>Owned: <span id="barracksOwned">0</span></p>
        </div>
        <div style="margin-top: 10px;">
          <p><strong>Marketplace</strong> (Increases passive income by 10% per Marketplace)</p>
          <p>Cost: <span id="marketplaceCost">300</span> Gold</p>
          <button id="buyMarketplace" title="Buy Marketplace">Buy Marketplace</button>
          <p>Owned: <span id="marketplaceOwned">0</span></p>
        </div>
        <div style="margin-top: 10px;">
          <p><strong>Castle</strong> (Increases overall gold multiplier by 0.2 per Castle)</p>
          <p>Cost: <span id="castleCost">500</span> Gold</p>
          <button id="buyCastle" title="Buy Castle">Buy Castle</button>
          <p>Owned: <span id="castleOwned">0</span></p>
        </div>
      </div>

      <!-- Hero & Battles Section -->
      <div class="section" id="rpgSection">
        <h2>Hero & Battles</h2>
        <div id="heroStatus">
          <p>Hero Level: <span id="heroLevel">1</span></p>
          <p>Hero XP: <span id="heroXP">0</span> / <span id="heroXPNeeded">50</span></p>
          <div id="xpBarContainer">
            <div id="xpBar"></div>
          </div>
          <p>Attack Power: <span id="heroAttack">1</span></p>
          <p>Health: <span id="heroHealth">100</span> / <span id="heroMaxHealth">100</span></p>
          <button id="healButton" title="Heal for 50 Gold">Heal (50 Gold)</button>
        </div>
        <div id="battleSection" style="margin-top: 15px;">
          <h3>Battle an Enemy <span id="enemyTypeLabel"></span></h3>
          <div id="enemyStatus">
            <p>Enemy HP: <span id="enemyHP">0</span></p>
            <div id="enemyHealthBarContainer">
              <div id="enemyHealthBar"></div>
            </div>
            <p>Reward: <span id="enemyReward">0</span> Gold, <span id="enemyXPReward">0</span> XP</p>
          </div>
          <button id="attackButton" title="Attack the enemy!">Attack!</button>
          <button id="specialAttackButton" title="Special Attack (Cooldown)">Special Attack!</button>
          <div id="specialCooldownBarContainer" style="margin-top:5px;">
            <div id="specialCooldownBar"></div>
          </div>
          <span id="specialCooldownDisplay"></span>
          <br>
          <button id="spawnEnemyButton" title="Spawn a new enemy">Spawn New Enemy</button>
        </div>
      </div>
    </div>
    <!-- Sidebar Column -->
    <div id="sidebarColumn">
      <!-- Prestige Section -->
      <div class="section" id="prestigeSection">
        <h2>Prestige</h2>
        <p>When your hero reaches Level 10, you can reset your progress for permanent benefits.</p>
        <p>Prestige Level: <span id="prestigeLevelDisplay">0</span></p>
        <p>Gold Multiplier: <span id="prestigeMultiplierDisplay">1.0</span>x</p>
        <p>Prestige Points: <span id="prestigePointsDisplay">0</span></p>
        <button id="prestigeButton" disabled title="Prestige Reset (requires Level 10)">Prestige Reset</button>
        <div id="reincarnateContainer" style="margin-top:10px;"></div>
        <hr>
        <h3>Prestige Upgrades</h3>
        <p>Divine Blessing: Increases gold multiplier by 0.2 (Cost: 1 Prestige Point)</p>
        <button id="buyPrestigeUpgrade" title="Buy Divine Blessing">Buy Divine Blessing</button>
        <p>Additional Multiplier: <span id="bonusMultiplierDisplay">0.0</span></p>
      </div>
      <!-- Quest Section -->
      <div class="section" id="questSection">
        <h2>Quests & Lore</h2>
        <p id="activeQuestText"></p>
        <p id="dailyChallengeText"></p>
        <ul id="questList"></ul>
      </div>
      <!-- Skill Tree Section -->
      <div class="section" id="skillTreeSection">
        <h2>Skill Tree</h2>
        <p>Invest in your abilities (each next skill unlocks only after purchasing the previous one):</p>
        <ul id="skillList">
          <!-- The skill list will be generated dynamically -->
        </ul>
      </div>
      <!-- Achievement Section -->
      <div class="section" id="achievementSection">
        <h2>Achievements</h2>
        <p>Track your milestones:</p>
        <ul id="achievementList">
          <!-- Achievements will be generated dynamically -->
        </ul>
      </div>
      <!-- Seasonal Event Section -->
      <div class="section" id="seasonalSection">
        <h2>Seasonal Event</h2>
        <p id="seasonalStatus">No event active.</p>
        <button id="activateEventButton" title="Activate a temporary festival with double gold">Activate Kingdom Festival (60s, double gold!)</button>
      </div>
      <!-- Leaderboard Section -->
      <div class="section" id="leaderboardSection">
        <h2>Leaderboard</h2>
        <p>Top High Scores:</p>
        <ul id="leaderboardList"></ul>
        <button id="shareScoreButton" title="Share your high score">Share Score</button>
      </div>
      <!-- Statistics Section -->
      <div class="section" id="statisticsSection">
        <h2>Statistics</h2>
        <p>Total Gold Earned: <span id="totalGoldEarned">0</span></p>
        <p>Total Clicks: <span id="totalClicks">0</span></p>
        <p>Battles Won: <span id="totalBattlesWon">0</span></p>
        <p>Highest Combo: <span id="highestCombo">1</span></p>
      </div>
      <!-- Event Log Section -->
      <div class="section" id="eventLogSection">
        <h2>Event Log</h2>
        <div id="eventLog"></div>
      </div>
      <!-- Miniâ€‘Game Trigger -->
      <div class="section">
        <h2>Miniâ€‘Game</h2>
        <p>Test your reflexes and win bonus gold!</p>
        <button id="startMiniGame" title="Start Miniâ€‘Game">Start Miniâ€‘Game</button>
      </div>
      <!-- Lore Section -->
      <div class="section" id="loreSection">
        <h2>Lore & World-Building</h2>
        <div id="staticLore">
          <p>Long ago in the Kingdom of Eldoria, mighty heroes and dastardly foes clashed for treasure and honor.</p>
        </div>
        <div id="dynamicLore"></div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      "use strict";
      // -------------------------
      // GLOBAL VARIABLES & STATE
      // -------------------------
      const saveVersion = 1;
      let gold = 0, goldPerClick = 1, goldMineOwned = 0, goldMineCost = 10, clickUpgradeCost = 25;
      let critChance = 0.10, critMultiplier = 2, critUpgradeCost = 50;
      let autoClickerOwned = 0, autoClickerCost = 50;
      let blacksmithLevel = 0, blacksmithCost = 100;
      // New Building variables
      let barracksOwned = 0, barracksCost = 200;
      let marketplaceOwned = 0, marketplaceCost = 300;
      let castleOwned = 0, castleCost = 500;
      // New upgrades:
      let guildLevel = 0, guildCost = 100;
      let mageTowerLevel = 0, mageTowerCost = 150;
      // Hero state:
      let hero = { level: 1, xp: 0, xpNeeded: 50, attack: 1, health: 100, maxHealth: 100 };
      let enemy = { maxHP: 0, currentHP: 0, rewardGold: 0, rewardXP: 0, level: 1, type: "Normal", dodgeChance: 0, counterDamage: 0, regen: 0 };
      let specialAvailable = true, specialCooldownTime = 10, specialCooldownRemaining = 0;
      let prestigeLevel = 0, prestigePoints = 0, bonusMultiplier = 0.0;
      function currentGoldMultiplier() { return 1 + prestigeLevel * 0.1 + bonusMultiplier; }
      let highScore = 0;
      let enemyDefeatedCount = 0, specialAttackCount = 0;
      // Daily Challenge
      let dailyChallenge = null;
      // Base Achievements
      const achievementsBase = [
        { id:1, desc: "First Click", condition: () => gold > 0, awarded: false },
        { id:2, desc: "Gold Hoarder (1,000 total earned)", condition: () => gold >= 1000, awarded: false },
        { id:3, desc: "Slayer (50 enemies defeated)", condition: () => enemyDefeatedCount >= 50, awarded: false },
        { id:4, desc: "Prestige Master (Prestige Level 5)", condition: () => prestigeLevel >= 5, awarded: false },
        { id:5, desc: "Quest Conqueror (Complete 5 quests)", condition: () => quests.filter(q => q.completed).length >= 5, awarded: false },
        { id:6, desc: "Herald's Blessing (Click a Royal Herald)", condition: () => clickedRoyalHerald, awarded: false }
      ];
      let achievements = achievementsBase.slice();
      function generateMedievalAchievementNames() {
        const adjectives = ["Brave", "Gallant", "Mighty", "Steadfast", "Fierce", "Honorable", "Valorous", "Chivalrous", "Glorious", "Epic"];
        const nouns = ["Victory", "Feat", "Triumph", "Conquest", "Glory", "Honor", "Legend", "Saga", "Tale", "Myth"];
        let names = [];
        for (let i = 0; i < 92; i++) {
          let adj = adjectives[i % adjectives.length];
          let noun = nouns[Math.floor(i / adjectives.length) % nouns.length];
          names.push(adj + " " + noun + " " + (i + 1));
        }
        return names;
      }
      const extraAchievementNames = generateMedievalAchievementNames();
      extraAchievementNames.forEach((name, index) => {
        achievements.push({
          id: achievements.length + 1,
          desc: name,
          condition: () => totalGoldEarned >= 1000 * (index + 1),
          awarded: false
        });
      });
      // Quests with lore for a linear narrative.
      const quests = [
        { id:1, desc: "Gather 100 Gold", lore: "The people of Eldoria hunger for wealth.", condition: () => gold >= 100, reward: () => { hero.xp += 10; } , completed: false },
        { id:2, desc: "Defeat 5 Enemies", lore: "Dark forces stir in the shadows.", condition: () => enemyDefeatedCount >= 5, reward: () => { gold += 20; }, completed: false },
        { id:3, desc: "Purchase 3 Gold Mines", lore: "Secure the kingdomâ€™s wealth by expanding your mines.", condition: () => goldMineOwned >= 3, reward: () => { hero.attack += 1; }, completed: false },
        { id:4, desc: "Reach Level 5", lore: "Prove your valor on the battlefield.", condition: () => hero.level >= 5, reward: () => { gold += 50; }, completed: false },
        { id:5, desc: "Use Special Attack 3 times", lore: "Master the art of devastating blows.", condition: () => specialAttackCount >= 3, reward: () => { hero.xp += 20; }, completed: false },
        { id:6, desc: "Unlock a new enemy type", lore: "New foes arise as challenges intensify.", condition: () => enemy.type !== "Normal", reward: () => { gold += 30; }, completed: false },
        { id:7, desc: "Complete 5 quests", lore: "Your legend grows with each epic feat.", condition: () => quests.filter(q => q.completed).length >= 5, reward: () => { gold += 100; }, completed: false }
      ];
      // Statistics
      let totalGoldEarned = 0, totalClicks = 0, totalBattlesWon = 0, highestCombo = 1;
      function addToStatistics(goldAmount, clicks = 0, battles = 0, combo = 1) {
        totalGoldEarned += goldAmount;
        totalClicks += clicks;
        totalBattlesWon += battles;
        if(combo > highestCombo) highestCombo = combo;
      }
      // Event Log
      let eventLog = [];
      function logEvent(message) {
        eventLog.push(message);
        if(eventLog.length > 10) { eventLog.shift(); }
        updateEventLog();
      }
      function updateEventLog() {
        eventLogDiv.innerHTML = "";
        eventLog.forEach(msg => {
          const p = document.createElement("p");
          p.textContent = msg;
          eventLogDiv.appendChild(p);
        });
      }
      // Miniâ€‘Game variables
      let miniGameClicks = 0, miniGameTimeLeft = 10, miniGameInterval = null;
      // Royal Herald flag
      let clickedRoyalHerald = false;
      // Auto clicker interval (in ms)
      let autoClickInterval = 3000;
      // Reincarnation
      let reincarnations = 0, reincarnationBonus = 0;
      // -------------------------
      // DOM ELEMENTS
      // -------------------------
      // Clicker
      const goldDisplay = document.getElementById("goldDisplay"),
            goldPerClickDisplay = document.getElementById("goldPerClickDisplay"),
            clickButton = document.getElementById("clickButton"),
            critChanceDisplay = document.getElementById("critChanceDisplay"),
            critMultiplierDisplay = document.getElementById("critMultiplierDisplay"),
            critUpgradeCostDisplay = document.getElementById("critUpgradeCostDisplay"),
            upgradeCritButton = document.getElementById("upgradeCrit");
      // Resource
      const buyGoldMineButton = document.getElementById("buyGoldMine"),
            goldMineCostDisplay = document.getElementById("goldMineCost"),
            goldMineOwnedDisplay = document.getElementById("goldMineOwned"),
            upgradeClickButton = document.getElementById("upgradeClick"),
            clickUpgradeCostDisplay = document.getElementById("clickUpgradeCost"),
            buyAutoClickerButton = document.getElementById("buyAutoClicker"),
            autoClickerCostDisplay = document.getElementById("autoClickerCost"),
            autoClickerOwnedDisplay = document.getElementById("autoClickerOwned"),
            hireBlacksmithButton = document.getElementById("hireBlacksmith"),
            blacksmithCostDisplay = document.getElementById("blacksmithCost"),
            blacksmithLevelDisplay = document.getElementById("blacksmithLevel");
      // New upgrade elements:
      const guildCostDisplay = document.getElementById("guildCost"),
            guildLevelDisplay = document.getElementById("guildLevel"),
            mageTowerCostDisplay = document.getElementById("mageTowerCost"),
            mageTowerLevelDisplay = document.getElementById("mageTowerLevel");
      // New Building displays:
      const barracksOwnedDisplay = document.getElementById("barracksOwned"),
            marketplaceOwnedDisplay = document.getElementById("marketplaceOwned"),
            castleOwnedDisplay = document.getElementById("castleOwned");
      // RPG / Battle
      const heroLevelDisplay = document.getElementById("heroLevel"),
            heroXPDisplay = document.getElementById("heroXP"),
            heroXPNeededDisplay = document.getElementById("heroXPNeeded"),
            heroAttackDisplay = document.getElementById("heroAttack"),
            xpBar = document.getElementById("xpBar"),
            enemyHPDisplay = document.getElementById("enemyHP"),
            enemyRewardDisplay = document.getElementById("enemyReward"),
            enemyXPRewardDisplay = document.getElementById("enemyXPReward"),
            enemyHealthBar = document.getElementById("enemyHealthBar"),
            attackButton = document.getElementById("attackButton"),
            specialAttackButton = document.getElementById("specialAttackButton"),
            specialCooldownDisplay = document.getElementById("specialCooldownDisplay"),
            spawnEnemyButton = document.getElementById("spawnEnemyButton"),
            documentHeaderEnemyType = document.getElementById("enemyTypeLabel"),
            specialCooldownBar = document.getElementById("specialCooldownBar");
      // Hero Health & Heal Button
      const heroHealthDisplay = document.getElementById("heroHealth"),
            heroMaxHealthDisplay = document.getElementById("heroMaxHealth"),
            healButton = document.getElementById("healButton");
      // Prestige
      const prestigeButton = document.getElementById("prestigeButton"),
            documentPrestigeLevel = document.getElementById("prestigeLevelDisplay"),
            documentPrestigeMultiplier = document.getElementById("prestigeMultiplierDisplay"),
            prestigePointsDisplay = document.getElementById("prestigePointsDisplay"),
            bonusMultiplierDisplay = document.getElementById("bonusMultiplierDisplay"),
            buyPrestigeUpgradeButton = document.getElementById("buyPrestigeUpgrade"),
            headerPrestigeLevel = document.getElementById("headerPrestigeLevel"),
            headerPrestigeMultiplier = document.getElementById("headerPrestigeMultiplier"),
            headerHighScore = document.getElementById("headerHighScore");
      // Quests & Lore
      const questListElem = document.getElementById("questList"),
            activeQuestText = document.getElementById("activeQuestText"),
            dynamicLoreContainer = document.getElementById("dynamicLore"),
            dailyChallengeText = document.getElementById("dailyChallengeText");
      // Skill Tree
      const skillListElem = document.getElementById("skillList");
      // Achievements
      const achievementListElem = document.getElementById("achievementList");
      // Seasonal event
      const seasonalStatusElem = document.getElementById("seasonalStatus"),
            activateEventButton = document.getElementById("activateEventButton");
      // Leaderboard
      const leaderboardListElem = document.getElementById("leaderboardList"),
            shareScoreButton = document.getElementById("shareScoreButton");
      // Statistics
      // (IDs "totalGoldEarned", "totalClicks", "totalBattlesWon", "highestCombo" are in the Statistics section)
      // Event Log
      const eventLogDiv = document.getElementById("eventLog");
      // Miniâ€‘Game
      const startMiniGameButton = document.getElementById("startMiniGame"),
            miniGameModal = document.getElementById("miniGameModal"),
            miniGameButton = document.getElementById("miniGameButton"),
            endMiniGameButton = document.getElementById("endMiniGameButton");
      // Reincarnation container
      const reincarnateContainer = document.getElementById("reincarnateContainer");
      // Settings
      const settingsButton = document.getElementById("settingsButton"),
            settingsModal = document.getElementById("settingsModal"),
            musicVolumeSlider = document.getElementById("musicVolumeSlider"),
            sfxVolumeSlider = document.getElementById("sfxVolumeSlider"),
            muteToggle = document.getElementById("muteToggle"),
            difficultySelect = document.getElementById("difficultySelect"),
            challengeModeToggle = document.getElementById("challengeModeToggle"),
            closeSettings = document.getElementById("closeSettings");
      // Tutorial
      const tutorialOverlay = document.getElementById("tutorialOverlay"),
            dismissTutorial = document.getElementById("dismissTutorial");
      // Audio elements
      const backgroundMusic = document.getElementById("backgroundMusic"),
            clickSound = document.getElementById("clickSound"),
            levelUpSound = document.getElementById("levelUpSound"),
            enemyDefeatedSound = document.getElementById("enemyDefeatedSound"),
            upgradeSound = document.getElementById("upgradeSound");

      // -------------------------
      // UTILITY FUNCTIONS
      // -------------------------
      function getPassiveIncomeMultiplier() {
        let extra = marketplaceOwned * 0.10; // Each Marketplace gives +10%
        return passiveBoost * (1 + guildLevel * 0.05 + extra);
      }
      // Define updateSkillTree() to manage sequential unlocking.
      function updateSkillTree() {
        const lis = document.querySelectorAll("#skillList li");
        for (let i = 0; i < skillOrder.length; i++) {
          const skillId = skillOrder[i];
          const li = Array.from(lis).find(item => item.getAttribute("data-id") === skillId);
          if(li) {
            if(i === 0) {
              li.style.display = "list-item";
            } else {
              const prevSkillId = skillOrder[i-1];
              li.style.display = skills[prevSkillId] && skills[prevSkillId].purchased ? "list-item" : "none";
            }
          }
        }
      }
      function updateSkillTreeDisplay() {
        updateSkillTree();
      }
      function updateDisplays() {
        goldDisplay.textContent = Math.floor(gold);
        goldPerClickDisplay.textContent = goldPerClick;
        critChanceDisplay.textContent = Math.floor(critChance * 100) + "%";
        critMultiplierDisplay.textContent = critMultiplier.toFixed(1) + "x";
        critUpgradeCostDisplay.textContent = critUpgradeCost;
        goldMineOwnedDisplay.textContent = goldMineOwned;
        goldMineCostDisplay.textContent = goldMineCost;
        clickUpgradeCostDisplay.textContent = clickUpgradeCost;
        autoClickerCostDisplay.textContent = autoClickerCost;
        autoClickerOwnedDisplay.textContent = autoClickerOwned;
        blacksmithCostDisplay.textContent = blacksmithCost;
        blacksmithLevelDisplay.textContent = blacksmithLevel;
        guildCostDisplay.textContent = guildCost;
        guildLevelDisplay.textContent = guildLevel;
        mageTowerCostDisplay.textContent = mageTowerCost;
        mageTowerLevelDisplay.textContent = mageTowerLevel;
        document.getElementById("barracksCost").textContent = barracksCost;
        barracksOwnedDisplay.textContent = barracksOwned;
        document.getElementById("marketplaceCost").textContent = marketplaceCost;
        marketplaceOwnedDisplay.textContent = marketplaceOwned;
        document.getElementById("castleCost").textContent = castleCost;
        castleOwnedDisplay.textContent = castleOwned;
        heroLevelDisplay.textContent = hero.level;
        heroXPDisplay.textContent = hero.xp;
        heroXPNeededDisplay.textContent = hero.xpNeeded;
        heroAttackDisplay.textContent = hero.attack;
        let xpPercent = (hero.xp / hero.xpNeeded) * 100;
        xpBar.style.width = xpPercent + "%";
        heroHealthDisplay.textContent = hero.health;
        heroMaxHealthDisplay.textContent = hero.maxHealth;
        enemyHPDisplay.textContent = enemy.currentHP < 0 ? 0 : enemy.currentHP;
        enemyRewardDisplay.textContent = enemy.rewardGold;
        enemyXPRewardDisplay.textContent = enemy.rewardXP;
        if (enemy.maxHP > 0) {
          let enemyHealthPercent = (enemy.currentHP / enemy.maxHP) * 100;
          enemyHealthBar.style.width = enemyHealthPercent + "%";
        } else {
          enemyHealthBar.style.width = "0%";
        }
        documentPrestigeLevel.textContent = prestigeLevel;
        documentPrestigeMultiplier.textContent = currentGoldMultiplier().toFixed(1);
        prestigePointsDisplay.textContent = prestigePoints;
        bonusMultiplierDisplay.textContent = bonusMultiplier.toFixed(1);
        headerPrestigeLevel.textContent = prestigeLevel;
        headerPrestigeMultiplier.textContent = currentGoldMultiplier().toFixed(1);
        headerHighScore.textContent = highScore;
        document.getElementById("headerRelics").textContent = relics;
        document.getElementById("totalGoldEarned").textContent = Math.floor(totalGoldEarned);
        document.getElementById("totalClicks").textContent = totalClicks;
        document.getElementById("totalBattlesWon").textContent = totalBattlesWon;
        document.getElementById("highestCombo").textContent = highestCombo.toFixed(1);
        updateQuestDisplay();
        updateSkillTreeDisplay();
        updateAchievementDisplay();
        updateLeaderboard();
      }
      function showNotification(message, duration = 2000) {
        notificationDiv.textContent = message;
        notificationDiv.classList.add("show");
        logEvent(message);
        setTimeout(() => { notificationDiv.classList.remove("show"); }, duration);
      }
      function createGoldFloat(amount, x, y) {
        const floatElem = document.createElement("span");
        floatElem.className = "gold-float";
        floatElem.textContent = "+" + Math.floor(amount);
        floatElem.style.left = x + "px";
        floatElem.style.top = y + "px";
        document.body.appendChild(floatElem);
        setTimeout(() => { floatElem.remove(); }, 1500);
      }
      function updateSpecialCooldownBar() {
        if(!specialAvailable) {
          let percent = ((specialCooldownTime - specialCooldownRemaining) / specialCooldownTime) * 100;
          specialCooldownBar.style.width = percent + "%";
          specialCooldownDisplay.textContent = "Cooldown: " + specialCooldownRemaining + "s";
        } else {
          specialCooldownBar.style.width = "100%";
          specialCooldownDisplay.textContent = "Ready!";
        }
      }
      // -------------------------
      // DAILY CHALLENGE
      // -------------------------
      const dailyChallenges = [
        "Earn 500 gold in one click!",
        "Defeat 3 enemies without healing!",
        "Upgrade 2 buildings in a row!",
        "Click 50 times in 10 seconds!",
        "Use a Special Attack to defeat an enemy!"
      ];
      function updateDailyChallenge() {
        const today = new Date().toISOString().slice(0,10);
        let stored = localStorage.getItem("dailyChallenge");
        if(stored) {
          let obj = JSON.parse(stored);
          if(obj.date === today) {
            dailyChallenge = obj.challenge;
          } else {
            dailyChallenge = dailyChallenges[Math.floor(Math.random() * dailyChallenges.length)];
            localStorage.setItem("dailyChallenge", JSON.stringify({ date: today, challenge: dailyChallenge }));
          }
        } else {
          dailyChallenge = dailyChallenges[Math.floor(Math.random() * dailyChallenges.length)];
          localStorage.setItem("dailyChallenge", JSON.stringify({ date: today, challenge: dailyChallenge }));
        }
        dailyChallengeText.textContent = "Daily Challenge: " + dailyChallenge;
      }
      updateDailyChallenge();
      // -------------------------
      // STATISTICS & EVENT LOG
      // -------------------------
      let totalGoldEarned = 0, totalClicks = 0, totalBattlesWon = 0, highestCombo = 1;
      function addToStatistics(goldAmount, clicks = 0, battles = 0, combo = 1) {
        totalGoldEarned += goldAmount;
        totalClicks += clicks;
        totalBattlesWon += battles;
        if(combo > highestCombo) highestCombo = combo;
      }
      let eventLog = [];
      function logEvent(message) {
        eventLog.push(message);
        if(eventLog.length > 10) { eventLog.shift(); }
        updateEventLog();
      }
      function updateEventLog() {
        eventLogDiv.innerHTML = "";
        eventLog.forEach(msg => {
          const p = document.createElement("p");
          p.textContent = msg;
          eventLogDiv.appendChild(p);
        });
      }
      // -------------------------
      // ROYAL HERALD
      // -------------------------
      let royalHeraldExists = false;
      function spawnRoyalHerald() {
        if (royalHeraldExists) return;
        royalHeraldExists = true;
        const herald = document.createElement("div");
        herald.className = "royal-herald";
        herald.textContent = "Royal Herald! Click for Fortune!";
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        herald.style.left = Math.random() * (vw - 200) + "px";
        herald.style.top = Math.random() * (vh - 50) + "px";
        document.body.appendChild(herald);
        herald.addEventListener("click", function() {
          clickedRoyalHerald = true;
          let bonusType = Math.random();
          if (bonusType < 0.33) {
            let bonusGold = 500;
            gold += bonusGold;
            showNotification("Royal Herald grants you " + bonusGold + " bonus gold!");
          } else if (bonusType < 0.66) {
            let bonusXP = 50;
            hero.xp += bonusXP;
            showNotification("Royal Herald bestows " + bonusXP + " bonus XP!");
          } else {
            temporaryGoldBonus = 2;
            showNotification("Royal Heraldâ€™s Decree! Gold earnings doubled for 30s!");
            setTimeout(() => { temporaryGoldBonus = 1; updateDisplays(); }, 30000);
          }
          herald.remove();
          royalHeraldExists = false;
          updateDisplays();
        });
        setTimeout(() => {
          if(document.body.contains(herald)) {
            herald.remove();
            royalHeraldExists = false;
          }
        }, 10000);
      }
      setInterval(() => { if(Math.random() < 0.3) spawnRoyalHerald(); }, 30000);
      // -------------------------
      // QUEST FUNCTIONS
      // -------------------------
      function updateQuestDisplay() {
        questListElem.innerHTML = "";
        let activeQuest = null;
        quests.sort((a,b) => a.id - b.id);
        quests.forEach(q => {
          const li = document.createElement("li");
          if(q.completed) {
            li.textContent = q.desc + " (Completed)";
            li.classList.add("completed");
          } else if(!activeQuest) {
            activeQuest = q;
            li.textContent = q.desc;
          } else {
            li.textContent = q.desc;
            li.style.opacity = "0.5";
          }
          questListElem.appendChild(li);
        });
        if(activeQuest) {
          activeQuestText.textContent = "Current Quest: " + activeQuest.desc;
        } else {
          activeQuestText.textContent = "All quests completed!";
        }
      }
      function appendLore(text) {
        const p = document.createElement("p");
        p.textContent = text;
        dynamicLoreContainer.appendChild(p);
      }
      function checkQuests() {
        quests.forEach(q => {
          if(!q.completed && q.condition()) {
            q.completed = true;
            q.reward();
            showNotification("Quest completed: " + q.desc, 2500);
            appendLore(q.lore);
          }
        });
      }
      // -------------------------
      // ACHIEVEMENT FUNCTIONS
      // -------------------------
      function updateAchievementDisplay() {
        achievementListElem.innerHTML = "";
        achievements.forEach(a => {
          const li = document.createElement("li");
          li.textContent = a.desc + (a.awarded ? " (Achieved)" : "");
          achievementListElem.appendChild(li);
        });
      }
      function checkAchievements() {
        achievements.forEach(a => {
          if(!a.awarded && a.condition()) {
            a.awarded = true;
            showNotification("Achievement unlocked: " + a.desc, 2500);
          }
        });
      }
      // -------------------------
      // SKILL TREE FUNCTIONS (Sequential Unlocking)
      // -------------------------
      function updateSkillTree() {
        const lis = document.querySelectorAll("#skillList li");
        for (let i = 0; i < skillOrder.length; i++) {
          const skillId = skillOrder[i];
          const li = Array.from(lis).find(item => item.getAttribute("data-id") === skillId);
          if(li) {
            if(i === 0) {
              li.style.display = "list-item";
            } else {
              const prevSkillId = skillOrder[i-1];
              li.style.display = (skills[prevSkillId] && skills[prevSkillId].purchased) ? "list-item" : "none";
            }
          }
        }
      }
      function updateSkillTreeDisplay() {
        updateSkillTree();
      }
      document.querySelectorAll(".buySkillBtn").forEach(btn => {
        btn.addEventListener("click", function(e) {
          const li = e.target.parentElement;
          const skillId = li.getAttribute("data-id");
          if(skills[skillId].purchased) {
            showNotification("Skill already purchased!");
            return;
          }
          if(gold >= skills[skillId].cost) {
            gold -= skills[skillId].cost;
            skills[skillId].purchased = true;
            skills[skillId].effect();
            li.style.textDecoration = "line-through";
            showNotification("Skill purchased: " + li.textContent, 2000);
            updateDisplays();
          } else {
            showNotification("Not enough gold for this skill!");
          }
        });
      });
      // -------------------------
      // REINCARNATION
      // -------------------------
      function updateReincarnation() {
        reincarnateContainer.innerHTML = "";
        if(prestigeLevel >= 10) {
          const btn = document.createElement("button");
          btn.textContent = "Reincarnate";
          btn.title = "Reincarnate for a permanent bonus (resets prestige)";
          btn.addEventListener("click", function() {
            reincarnations++;
            reincarnationBonus += 0.05;
            prestigeLevel = 0;
            prestigePoints = 0;
            bonusMultiplier = reincarnationBonus;
            showNotification("Reincarnation complete! Permanent bonus increased.", 3000);
            updateDisplays();
            updateReincarnation();
          });
          reincarnateContainer.appendChild(btn);
        }
      }
      // -------------------------
      // MINIâ€‘GAME FUNCTIONS
      // -------------------------
      startMiniGameButton.addEventListener("click", function() {
        miniGameClicks = 0;
        miniGameTimeLeft = 10;
        document.getElementById("miniGameClicks").textContent = miniGameClicks;
        document.getElementById("miniGameTimer").textContent = "Time left: 10s";
        miniGameModal.style.display = "block";
        endMiniGameButton.style.display = "none";
        miniGameInterval = setInterval(() => {
          miniGameTimeLeft--;
          document.getElementById("miniGameTimer").textContent = "Time left: " + miniGameTimeLeft + "s";
          if(miniGameTimeLeft <= 0) {
            clearInterval(miniGameInterval);
            endMiniGame();
          }
        }, 1000);
      });
      miniGameButton.addEventListener("click", function() {
        miniGameClicks++;
        document.getElementById("miniGameClicks").textContent = miniGameClicks;
      });
      endMiniGameButton.addEventListener("click", function() {
        endMiniGame();
      });
      function endMiniGame() {
        clearInterval(miniGameInterval);
        miniGameModal.style.display = "none";
        let bonusGold = miniGameClicks * 10;
        gold += bonusGold;
        showNotification("Miniâ€‘Game complete! You earned " + bonusGold + " bonus gold!");
        addToStatistics(bonusGold, miniGameClicks);
        updateDisplays();
      }
      // -------------------------
      // DYNAMIC EXTRA CONTENT (Extra Skills & Extra Achievements)
      // -------------------------
      // (Extra skills and achievements were generated during initialization.)
      // -------------------------
      // -------------------------
      // PRESTIGE & REINCARNATION
      // -------------------------
      prestigeButton.addEventListener("click", function() {
        if(hero.level < 10) { showNotification("You need to be at least Level 10 to Prestige!"); return; }
        prestigeLevel++;
        prestigePoints++;
        showNotification("Prestige Activated! Gold Multiplier is now " + currentGoldMultiplier().toFixed(1) + "x", 3000);
        if(gold > highScore) highScore = gold;
        leaderboard.push({ name: "Hero", score: gold });
        gold = 0; goldPerClick = 1; goldMineOwned = 0; goldMineCost = 10; clickUpgradeCost = 25;
        critChance = 0.10; critMultiplier = 2; critUpgradeCost = 50;
        autoClickerOwned = 0; autoClickerCost = 50;
        blacksmithLevel = 0; blacksmithCost = 100;
        guildLevel = 0; guildCost = 100;
        mageTowerLevel = 0; mageTowerCost = 150;
        barracksOwned = 0; barracksCost = 200;
        marketplaceOwned = 0; marketplaceCost = 300;
        castleOwned = 0; castleCost = 500;
        hero = { level: 1, xp: 0, xpNeeded: 50, attack: 1, health: 100, maxHealth: 100 };
        spawnEnemy();
        updateDisplays();
        prestigeButton.disabled = true;
        attackButton.disabled = false;
        specialAttackButton.disabled = false;
        logEvent("Prestige activated!");
        updateReincarnation();
      });
      buyPrestigeUpgradeButton.addEventListener("click", function() {
        if(prestigePoints > 0) {
          prestigePoints--;
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Divine Blessing purchased! Bonus multiplier increased.", 2500);
          updateDisplays();
        } else {
          showNotification("Not enough Prestige Points!");
        }
      });
      // -------------------------
      // STATISTICS & EVENT LOG UPDATES
      // -------------------------
      setInterval(() => { checkQuests(); checkAchievements(); }, 2000);
      function updateLeaderboard() {
        leaderboardListElem.innerHTML = "";
        let sorted = leaderboard.sort((a,b) => b.score - a.score).slice(0, 5);
        sorted.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = entry.name + ": " + Math.floor(entry.score);
          leaderboardListElem.appendChild(li);
        });
      }
      // -------------------------
      // MINIâ€‘GAME TRIGGER & FUNCTIONS (already set above)
      // -------------------------
      // -------------------------
      // ENEMY SPAWNING
      // -------------------------
      function spawnEnemy() {
        enemy.level = hero.level;
        let r = Math.random();
        if(r < 0.2) {
          enemy.type = "Boss";
          enemy.maxHP = ((10 + enemy.level * 5) * 3) * difficultyMultiplier * (challengeMode ? 1.2 : 1);
          enemy.rewardGold = ((5 + enemy.level * 2) * 3);
          enemy.rewardXP = ((10 + enemy.level * 3) * 3);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 3;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Boss)";
        } else if(r < 0.3) {
          enemy.type = "Armored";
          enemy.maxHP = Math.floor((10 + enemy.level * 5) * 1.5 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.2);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 0.8);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Armored)";
        } else if(r < 0.4) {
          enemy.type = "Agile";
          enemy.maxHP = (10 + enemy.level * 5) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0.3;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Agile)";
        } else if(r < 0.5) {
          enemy.type = "Regenerator";
          enemy.maxHP = Math.floor((10 + enemy.level * 5) * 1.2 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.1);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 1.1);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = Math.floor(enemy.maxHP * 0.02);
          documentHeaderEnemyType.textContent = "(Regenerator)";
        } else {
          enemy.type = "Normal";
          enemy.maxHP = (10 + enemy.level * 5) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "";
        }
        enemy.currentHP = enemy.maxHP;
        updateDisplays();
      }
      // -------------------------
      // LEVEL-UP & BATTLE FUNCTIONS
      // -------------------------
      function checkLevelUp() {
        while(hero.xp >= hero.xpNeeded) {
          hero.xp -= hero.xpNeeded;
          hero.level++;
          hero.attack++;
          hero.maxHealth += 20;
          hero.health = hero.maxHealth;
          hero.xpNeeded = Math.floor(hero.xpNeeded * 1.5);
          showNotification("Level Up! You are now level " + hero.level + "!", 2500);
          if(!muteSound) levelUpSound.play();
          updateDisplays();
          if(hero.level >= 10) prestigeButton.disabled = false;
        }
      }
      // -------------------------
      // SAVE/LOAD & OFFLINE PROGRESS
      // -------------------------
      function saveGame() {
        try {
          const state = {
            saveVersion,
            gold, goldPerClick, goldMineOwned, goldMineCost, clickUpgradeCost,
            critChance, critMultiplier, critUpgradeCost,
            autoClickerOwned, autoClickerCost, blacksmithLevel, blacksmithCost,
            guildLevel, guildCost, mageTowerLevel, mageTowerCost,
            barracksOwned, barracksCost, marketplaceOwned, marketplaceCost, castleOwned, castleCost,
            hero, enemyDefeatedCount, specialAttackCount,
            prestigeLevel, prestigePoints, bonusMultiplier,
            highScore, passiveBoost, relics,
            quests, achievements, skills,
            lastSaveTime: Date.now(),
            leaderboard
          };
          localStorage.setItem("medievalIdleSave", JSON.stringify(state));
        } catch(e) {
          console.error("Error saving game:", e);
        }
      }
      function loadGame() {
        try {
          const stateStr = localStorage.getItem("medievalIdleSave");
          if(stateStr) {
            const state = JSON.parse(stateStr);
            if(state.saveVersion !== saveVersion) {
              console.warn("Save version mismatch â€“ starting fresh.");
              return;
            }
            gold = state.gold; goldPerClick = state.goldPerClick; goldMineOwned = state.goldMineOwned;
            goldMineCost = state.goldMineCost; clickUpgradeCost = state.clickUpgradeCost;
            critChance = state.critChance; critMultiplier = state.critMultiplier; critUpgradeCost = state.critUpgradeCost;
            autoClickerOwned = state.autoClickerOwned; autoClickerCost = state.autoClickerCost;
            blacksmithLevel = state.blacksmithLevel; blacksmithCost = state.blacksmithCost;
            guildLevel = state.guildLevel; guildCost = state.guildCost;  // FIXED: use state.guildCost
            mageTowerLevel = state.mageTowerLevel; mageTowerCost = state.mageTowerCost;
            barracksOwned = state.barracksOwned; barracksCost = state.barracksCost;
            marketplaceOwned = state.marketplaceOwned; marketplaceCost = state.marketplaceCost;
            castleOwned = state.castleOwned; castleCost = state.castleCost;
            hero = state.hero; enemyDefeatedCount = state.enemyDefeatedCount; specialAttackCount = state.specialAttackCount;
            prestigeLevel = state.prestigeLevel; prestigePoints = state.prestigePoints; bonusMultiplier = state.bonusMultiplier;
            highScore = state.highScore; passiveBoost = state.passiveBoost; relics = state.relics;
            leaderboard = state.leaderboard || [];
            lastSaveTime = state.lastSaveTime;
            const offlineSeconds = Math.floor((Date.now() - lastSaveTime) / 1000);
            const offlineGold = offlineSeconds * (goldMineOwned + autoClickerOwned * goldPerClick) * currentGoldMultiplier() * getPassiveIncomeMultiplier();
            gold += offlineGold;
            totalGoldEarned += offlineGold;
            showNotification("Welcome back! You earned " + Math.floor(offlineGold) + " gold offline.", 3000);
          }
        } catch(e) {
          console.error("Error loading game:", e);
        }
      }
      window.addEventListener("beforeunload", saveGame);
      window.addEventListener("load", () => {
        loadGame();
        updateDisplays();
        spawnEnemy();
        backgroundMusic.volume = musicVolume;
        backgroundMusic.play().catch(err => console.log("Autoplay prevented", err));
        autoClickerLoop();
        updateDailyChallenge();
        updateReincarnation();
        if(!localStorage.getItem("tutorialSeen")) {
          tutorialOverlay.style.display = "flex";
        }
      });
      // -------------------------
      // AUTO CLICKER LOOP (using setTimeout for dynamic interval)
      // -------------------------
      function autoClickerLoop() {
        setTimeout(function() {
          if(autoClickerOwned > 0) {
            let income = autoClickerOwned * goldPerClick * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
            gold += income;
            totalGoldEarned += income;
            updateDisplays();
          }
          autoClickerLoop();
        }, autoClickInterval);
      }
      // -------------------------
      // GAME LOOP (using requestAnimationFrame)
      // -------------------------
      function gameLoop() {
        updateSpecialCooldownBar();
        if(enemy.type === "Regenerator" && enemy.currentHP > 0) {
          enemy.currentHP = Math.min(enemy.currentHP + enemy.regen * 0.016, enemy.maxHP);
          updateDisplays();
        }
        requestAnimationFrame(gameLoop);
      }
      gameLoop();
      // -------------------------
      // EVENT LISTENERS & GAMEPLAY
      // -------------------------
      clickButton.addEventListener("click", function(e) {
        if(!muteSound) clickSound.play();
        totalClicks++;
        let goldEarned = goldPerClick;
        if(Math.random() < critChance) {
          goldEarned *= critMultiplier;
          showNotification("Critical Strike! +" + Math.floor(goldEarned * currentGoldMultiplier() * temporaryGoldBonus) + " Gold", 1500);
        }
        const totalGold = goldEarned * currentGoldMultiplier() * temporaryGoldBonus;
        gold += totalGold;
        totalGoldEarned += totalGold;
        createGoldFloat(totalGold, e.clientX, e.clientY);
        updateDisplays();
        checkAchievements();
        checkQuests();
      });
      upgradeCritButton.addEventListener("click", function() {
        if(gold >= critUpgradeCost) {
          gold -= critUpgradeCost;
          critChance += 0.05;
          critUpgradeCost = Math.floor(critUpgradeCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade Critical Strike!"); }
      });
      buyGoldMineButton.addEventListener("click", function() {
        if(gold >= goldMineCost) {
          gold -= goldMineCost;
          goldMineOwned++;
          goldMineCost = Math.floor(goldMineCost * 1.15);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
          checkQuests();
        } else { showNotification("Not enough gold for Gold Mine!"); }
      });
      upgradeClickButton.addEventListener("click", function() {
        if(gold >= clickUpgradeCost) {
          gold -= clickUpgradeCost;
          goldPerClick++;
          clickUpgradeCost = Math.floor(clickUpgradeCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade click power!"); }
      });
      buyAutoClickerButton.addEventListener("click", function() {
        if(gold >= autoClickerCost) {
          gold -= autoClickerCost;
          autoClickerOwned++;
          autoClickerCost = Math.floor(autoClickerCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold for Auto Clicker!"); }
      });
      hireBlacksmithButton.addEventListener("click", function() {
        if(gold >= blacksmithCost) {
          gold -= blacksmithCost;
          blacksmithLevel++;
          hero.attack += 1;
          blacksmithCost = Math.floor(blacksmithCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to hire Blacksmith!"); }
      });
      document.getElementById("buyGuild").addEventListener("click", function() {
        if(gold >= guildCost) {
          gold -= guildCost;
          guildLevel++;
          guildCost = Math.floor(guildCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Adventurer's Guild upgraded! Passive income increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Adventurer's Guild!"); }
      });
      document.getElementById("buyMageTower").addEventListener("click", function() {
        if(gold >= mageTowerCost) {
          gold -= mageTowerCost;
          mageTowerLevel++;
          mageTowerCost = Math.floor(mageTowerCost * 1.4);
          critMultiplier += 0.1;
          if(!muteSound) upgradeSound.play();
          showNotification("Mage Tower built! Critical multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Mage Tower!"); }
      });
      document.getElementById("buyBarracks").addEventListener("click", function() {
        if(gold >= barracksCost) {
          gold -= barracksCost;
          barracksOwned++;
          barracksCost = Math.floor(barracksCost * 1.25);
          hero.attack += 3;
          if(!muteSound) upgradeSound.play();
          showNotification("Barracks acquired! +3 attack per Barracks.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Barracks!"); }
      });
      document.getElementById("buyMarketplace").addEventListener("click", function() {
        if(gold >= marketplaceCost) {
          gold -= marketplaceCost;
          marketplaceOwned++;
          marketplaceCost = Math.floor(marketplaceCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Marketplace acquired! Passive income boosted.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Marketplace!"); }
      });
      document.getElementById("buyCastle").addEventListener("click", function() {
        if(gold >= castleCost) {
          gold -= castleCost;
          castleOwned++;
          castleCost = Math.floor(castleCost * 1.4);
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Castle built! Gold multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Castle!"); }
      });
      healButton.addEventListener("click", function() {
        if(gold >= healCost) {
          gold -= healCost;
          hero.health = Math.min(hero.health + healAmount, hero.maxHealth);
          showNotification("Healed for " + healAmount + " HP!");
          updateDisplays();
        } else { showNotification("Not enough gold to heal!"); }
      });
      setInterval(function() {
        let income = goldMineOwned * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
        gold += income;
        totalGoldEarned += income;
        updateDisplays();
      }, 1000);
      attackButton.addEventListener("click", function() {
        if(enemy.currentHP > 0) {
          const currentTime = Date.now();
          if(currentTime - lastAttackTime < 2000) {
            comboMultiplier += 0.1;
          } else {
            comboMultiplier = 1;
          }
          lastAttackTime = currentTime;
          let damage = hero.attack * comboMultiplier;
          if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance) {
            showNotification("Enemy dodged your attack!");
          } else {
            enemy.currentHP -= damage;
            if(comboMultiplier > 1) {
              showNotification("Combo x" + comboMultiplier.toFixed(1) + " for " + Math.floor(damage) + " damage!");
            }
          }
          if(enemy.currentHP > 0 && Math.random() < 0.2) {
            let counterDmg = enemy.counterDamage;
            hero.health -= counterDmg;
            showNotification("Enemy counterattacked for " + counterDmg + " damage!");
            if(hero.health <= 0) {
              hero.health = 0;
              showNotification("You died! Prestige to reset.", 4000);
              attackButton.disabled = true;
              specialAttackButton.disabled = true;
              totalBattlesWon++;
              return;
            }
          }
          if(enemy.currentHP <= 0) {
            if(!muteSound) enemyDefeatedSound.play();
            enemyDefeatedCount++;
            totalBattlesWon++;
            if(enemy.type === "Boss") relics++;
            gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
            hero.xp += enemy.rewardXP;
            showNotification("Enemy defeated! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
            spawnEnemy();
            checkLevelUp();
          }
          updateDisplays();
          checkQuests();
          checkAchievements();
        } else { showNotification("Spawn an enemy first!"); }
      });
      specialAttackButton.addEventListener("click", function() {
        if(!specialAvailable) { showNotification("Special Attack is on cooldown!"); return; }
        if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance/2) {
          showNotification("Enemy evaded your Special Attack!");
        } else {
          enemy.currentHP -= hero.attack * 3;
          specialAttackCount++;
          showNotification("Special Attack dealt " + (hero.attack * 3) + " damage!");
        }
        if(enemy.currentHP <= 0) {
          if(!muteSound) enemyDefeatedSound.play();
          enemyDefeatedCount++;
          gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
          hero.xp += enemy.rewardXP;
          showNotification("Enemy defeated with Special Attack! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
          spawnEnemy();
          checkLevelUp();
        }
        updateDisplays();
        specialAvailable = false;
        specialAttackButton.disabled = true;
        specialCooldownRemaining = specialCooldownTime;
      });
      setInterval(function(){
        if(!specialAvailable && specialCooldownRemaining > 0) {
          specialCooldownRemaining--;
          if(specialCooldownRemaining <= 0) {
            specialAvailable = true;
            specialAttackButton.disabled = false;
          }
        }
      }, 1000);
      spawnEnemyButton.addEventListener("click", spawnEnemy);
      // -------------------------
      // PRESTIGE & REINCARNATION
      // -------------------------
      prestigeButton.addEventListener("click", function() {
        if(hero.level < 10) { showNotification("You need to be at least Level 10 to Prestige!"); return; }
        prestigeLevel++;
        prestigePoints++;
        showNotification("Prestige Activated! Gold Multiplier is now " + currentGoldMultiplier().toFixed(1) + "x", 3000);
        if(gold > highScore) highScore = gold;
        leaderboard.push({ name: "Hero", score: gold });
        gold = 0; goldPerClick = 1; goldMineOwned = 0; goldMineCost = 10; clickUpgradeCost = 25;
        critChance = 0.10; critMultiplier = 2; critUpgradeCost = 50;
        autoClickerOwned = 0; autoClickerCost = 50;
        blacksmithLevel = 0; blacksmithCost = 100;
        guildLevel = 0; guildCost = 100;
        mageTowerLevel = 0; mageTowerCost = 150;
        barracksOwned = 0; barracksCost = 200;
        marketplaceOwned = 0; marketplaceCost = 300;
        castleOwned = 0; castleCost = 500;
        hero = { level: 1, xp: 0, xpNeeded: 50, attack: 1, health: 100, maxHealth: 100 };
        spawnEnemy();
        updateDisplays();
        prestigeButton.disabled = true;
        attackButton.disabled = false;
        specialAttackButton.disabled = false;
        logEvent("Prestige activated!");
        updateReincarnation();
      });
      buyPrestigeUpgradeButton.addEventListener("click", function() {
        if(prestigePoints > 0) {
          prestigePoints--;
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Divine Blessing purchased! Bonus multiplier increased.", 2500);
          updateDisplays();
        } else {
          showNotification("Not enough Prestige Points!");
        }
      });
      // -------------------------
      // STATISTICS & EVENT LOG UPDATES
      // -------------------------
      setInterval(() => { checkQuests(); checkAchievements(); }, 2000);
      function updateLeaderboard() {
        leaderboardListElem.innerHTML = "";
        let sorted = leaderboard.sort((a,b) => b.score - a.score).slice(0, 5);
        sorted.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = entry.name + ": " + Math.floor(entry.score);
          leaderboardListElem.appendChild(li);
        });
      }
      // -------------------------
      // SETTINGS & TUTORIAL FUNCTIONS
      // -------------------------
      settingsButton.addEventListener("click", function() {
        settingsModal.style.display = "block";
        musicVolumeSlider.value = musicVolume;
        sfxVolumeSlider.value = sfxVolume;
        muteToggle.checked = muteSound;
        difficultySelect.value = difficultyMultiplier;
        challengeModeToggle.checked = challengeMode;
      });
      closeSettings.addEventListener("click", function() {
        difficultyMultiplier = parseFloat(difficultySelect.value);
        challengeMode = challengeModeToggle.checked;
        settingsModal.style.display = "none";
        showNotification("Settings updated.");
      });
      musicVolumeSlider.addEventListener("input", function() {
        musicVolume = parseFloat(this.value);
        backgroundMusic.volume = musicVolume;
      });
      sfxVolumeSlider.addEventListener("input", function() {
        sfxVolume = parseFloat(this.value);
      });
      muteToggle.addEventListener("change", function() {
        muteSound = this.checked;
        if(muteSound) {
          backgroundMusic.pause();
        } else {
          backgroundMusic.play();
        }
      });
      shareScoreButton.addEventListener("click", function() {
        if(navigator.share) {
          navigator.share({
            title: "Medieval Idle Adventure",
            text: "My high score is " + highScore + " gold and " + relics + " relics!",
          }).then(() => console.log("Score shared!"))
            .catch(err => console.error("Error sharing:", err));
        } else {
          showNotification("Sharing not supported on this browser.");
        }
      });
      dismissTutorial.addEventListener("click", function() {
        tutorialOverlay.style.display = "none";
        localStorage.setItem("tutorialSeen", "true");
        backgroundMusic.play().catch(err => console.log("Music play error:", err));
      });
      // -------------------------
      // MINIâ€‘GAME FUNCTIONS
      // -------------------------
      startMiniGameButton.addEventListener("click", function() {
        miniGameClicks = 0;
        miniGameTimeLeft = 10;
        document.getElementById("miniGameClicks").textContent = miniGameClicks;
        document.getElementById("miniGameTimer").textContent = "Time left: 10s";
        miniGameModal.style.display = "block";
        endMiniGameButton.style.display = "none";
        miniGameInterval = setInterval(() => {
          miniGameTimeLeft--;
          document.getElementById("miniGameTimer").textContent = "Time left: " + miniGameTimeLeft + "s";
          if(miniGameTimeLeft <= 0) {
            clearInterval(miniGameInterval);
            endMiniGame();
          }
        }, 1000);
      });
      miniGameButton.addEventListener("click", function() {
        miniGameClicks++;
        document.getElementById("miniGameClicks").textContent = miniGameClicks;
      });
      endMiniGameButton.addEventListener("click", function() {
        endMiniGame();
      });
      function endMiniGame() {
        clearInterval(miniGameInterval);
        miniGameModal.style.display = "none";
        let bonusGold = miniGameClicks * 10;
        gold += bonusGold;
        showNotification("Miniâ€‘Game complete! You earned " + bonusGold + " bonus gold!");
        addToStatistics(bonusGold, miniGameClicks);
        updateDisplays();
      }
      // -------------------------
      // DYNAMIC EXTRA CONTENT (Extra Skills & Extra Achievements)
      // -------------------------
      // (Extra skills and achievements were generated during initialization.)
      // -------------------------
      // PRESTIGE & REINCARNATION are handled above.
      // -------------------------
      // MINIâ€‘GAME: Already handled.
      // -------------------------
      // ENEMY SPAWNING (with enhanced types)
      // -------------------------
      function spawnEnemy() {
        enemy.level = hero.level;
        let r = Math.random();
        if(r < 0.2) {
          enemy.type = "Boss";
          enemy.maxHP = ((10 + enemy.level * 5) * 3) * difficultyMultiplier * (challengeMode ? 1.2 : 1);
          enemy.rewardGold = ((5 + enemy.level * 2) * 3);
          enemy.rewardXP = ((10 + enemy.level * 3) * 3);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 3;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Boss)";
        } else if(r < 0.3) {
          enemy.type = "Armored";
          enemy.maxHP = Math.floor((10 + enemy.level * 5) * 1.5 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.2);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 0.8);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Armored)";
        } else if(r < 0.4) {
          enemy.type = "Agile";
          enemy.maxHP = (10 + enemy.level * 5) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0.3;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Agile)";
        } else if(r < 0.5) {
          enemy.type = "Regenerator";
          enemy.maxHP = Math.floor((10 + enemy.level * 5) * 1.2 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.1);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 1.1);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = Math.floor(enemy.maxHP * 0.02);
          documentHeaderEnemyType.textContent = "(Regenerator)";
        } else {
          enemy.type = "Normal";
          enemy.maxHP = (10 + enemy.level * 5) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "";
        }
        enemy.currentHP = enemy.maxHP;
        updateDisplays();
      }
      // -------------------------
      // LEVEL-UP & BATTLE FUNCTIONS
      // -------------------------
      function checkLevelUp() {
        while(hero.xp >= hero.xpNeeded) {
          hero.xp -= hero.xpNeeded;
          hero.level++;
          hero.attack++;
          hero.maxHealth += 20;
          hero.health = hero.maxHealth;
          hero.xpNeeded = Math.floor(hero.xpNeeded * 1.5);
          showNotification("Level Up! You are now level " + hero.level + "!", 2500);
          if(!muteSound) levelUpSound.play();
          updateDisplays();
          if(hero.level >= 10) prestigeButton.disabled = false;
        }
      }
      // -------------------------
      // SAVE/LOAD & OFFLINE PROGRESS
      // -------------------------
      function saveGame() {
        try {
          const state = {
            saveVersion,
            gold, goldPerClick, goldMineOwned, goldMineCost, clickUpgradeCost,
            critChance, critMultiplier, critUpgradeCost,
            autoClickerOwned, autoClickerCost, blacksmithLevel, blacksmithCost,
            guildLevel, guildCost, mageTowerLevel, mageTowerCost,
            barracksOwned, barracksCost, marketplaceOwned, marketplaceCost, castleOwned, castleCost,
            hero, enemyDefeatedCount, specialAttackCount,
            prestigeLevel, prestigePoints, bonusMultiplier,
            highScore, passiveBoost, relics,
            quests, achievements, skills,
            lastSaveTime: Date.now(),
            leaderboard
          };
          localStorage.setItem("medievalIdleSave", JSON.stringify(state));
        } catch(e) {
          console.error("Error saving game:", e);
        }
      }
      function loadGame() {
        try {
          const stateStr = localStorage.getItem("medievalIdleSave");
          if(stateStr) {
            const state = JSON.parse(stateStr);
            if(state.saveVersion !== saveVersion) {
              console.warn("Save version mismatch â€“ starting fresh.");
              return;
            }
            gold = state.gold; goldPerClick = state.goldPerClick; goldMineOwned = state.goldMineOwned;
            goldMineCost = state.goldMineCost; clickUpgradeCost = state.clickUpgradeCost;
            critChance = state.critChance; critMultiplier = state.critMultiplier; critUpgradeCost = state.critUpgradeCost;
            autoClickerOwned = state.autoClickerOwned; autoClickerCost = state.autoClickerCost;
            blacksmithLevel = state.blacksmithLevel; blacksmithCost = state.blacksmithCost;
            guildLevel = state.guildLevel; guildCost = state.guildCost;  // FIXED HERE
            mageTowerLevel = state.mageTowerLevel; mageTowerCost = state.mageTowerCost;
            barracksOwned = state.barracksOwned; barracksCost = state.barracksCost;
            marketplaceOwned = state.marketplaceOwned; marketplaceCost = state.marketplaceCost;
            castleOwned = state.castleOwned; castleCost = state.castleCost;
            hero = state.hero; enemyDefeatedCount = state.enemyDefeatedCount; specialAttackCount = state.specialAttackCount;
            prestigeLevel = state.prestigeLevel; prestigePoints = state.prestigePoints; bonusMultiplier = state.bonusMultiplier;
            highScore = state.highScore; passiveBoost = state.passiveBoost; relics = state.relics;
            leaderboard = state.leaderboard || [];
            lastSaveTime = state.lastSaveTime;
            const offlineSeconds = Math.floor((Date.now() - lastSaveTime) / 1000);
            const offlineGold = offlineSeconds * (goldMineOwned + autoClickerOwned * goldPerClick) * currentGoldMultiplier() * getPassiveIncomeMultiplier();
            gold += offlineGold;
            totalGoldEarned += offlineGold;
            showNotification("Welcome back! You earned " + Math.floor(offlineGold) + " gold offline.", 3000);
          }
        } catch(e) {
          console.error("Error loading game:", e);
        }
      }
      window.addEventListener("beforeunload", saveGame);
      window.addEventListener("load", () => {
        loadGame();
        updateDisplays();
        spawnEnemy();
        backgroundMusic.volume = musicVolume;
        backgroundMusic.play().catch(err => console.log("Autoplay prevented", err));
        autoClickerLoop();
        updateDailyChallenge();
        updateReincarnation();
        if(!localStorage.getItem("tutorialSeen")) {
          tutorialOverlay.style.display = "flex";
        }
      });
      // -------------------------
      // AUTO CLICKER LOOP (using setTimeout)
      // -------------------------
      function autoClickerLoop() {
        setTimeout(function() {
          if(autoClickerOwned > 0) {
            let income = autoClickerOwned * goldPerClick * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
            gold += income;
            totalGoldEarned += income;
            updateDisplays();
          }
          autoClickerLoop();
        }, autoClickInterval);
      }
      // -------------------------
      // GAME LOOP (using requestAnimationFrame)
      // -------------------------
      function gameLoop() {
        updateSpecialCooldownBar();
        if(enemy.type === "Regenerator" && enemy.currentHP > 0) {
          enemy.currentHP = Math.min(enemy.currentHP + enemy.regen * 0.016, enemy.maxHP);
          updateDisplays();
        }
        requestAnimationFrame(gameLoop);
      }
      gameLoop();
      // -------------------------
      // EVENT LISTENERS & GAMEPLAY
      // -------------------------
      clickButton.addEventListener("click", function(e) {
        if(!muteSound) clickSound.play();
        totalClicks++;
        let goldEarned = goldPerClick;
        if(Math.random() < critChance) {
          goldEarned *= critMultiplier;
          showNotification("Critical Strike! +" + Math.floor(goldEarned * currentGoldMultiplier() * temporaryGoldBonus) + " Gold", 1500);
        }
        const totalGold = goldEarned * currentGoldMultiplier() * temporaryGoldBonus;
        gold += totalGold;
        totalGoldEarned += totalGold;
        createGoldFloat(totalGold, e.clientX, e.clientY);
        updateDisplays();
        checkAchievements();
        checkQuests();
      });
      upgradeCritButton.addEventListener("click", function() {
        if(gold >= critUpgradeCost) {
          gold -= critUpgradeCost;
          critChance += 0.05;
          critUpgradeCost = Math.floor(critUpgradeCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade Critical Strike!"); }
      });
      buyGoldMineButton.addEventListener("click", function() {
        if(gold >= goldMineCost) {
          gold -= goldMineCost;
          goldMineOwned++;
          goldMineCost = Math.floor(goldMineCost * 1.15);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
          checkQuests();
        } else { showNotification("Not enough gold for Gold Mine!"); }
      });
      upgradeClickButton.addEventListener("click", function() {
        if(gold >= clickUpgradeCost) {
          gold -= clickUpgradeCost;
          goldPerClick++;
          clickUpgradeCost = Math.floor(clickUpgradeCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade click power!"); }
      });
      buyAutoClickerButton.addEventListener("click", function() {
        if(gold >= autoClickerCost) {
          gold -= autoClickerCost;
          autoClickerOwned++;
          autoClickerCost = Math.floor(autoClickerCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold for Auto Clicker!"); }
      });
      hireBlacksmithButton.addEventListener("click", function() {
        if(gold >= blacksmithCost) {
          gold -= blacksmithCost;
          blacksmithLevel++;
          hero.attack += 1;
          blacksmithCost = Math.floor(blacksmithCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to hire Blacksmith!"); }
      });
      document.getElementById("buyGuild").addEventListener("click", function() {
        if(gold >= guildCost) {
          gold -= guildCost;
          guildLevel++;
          guildCost = Math.floor(guildCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Adventurer's Guild upgraded! Passive income increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Adventurer's Guild!"); }
      });
      document.getElementById("buyMageTower").addEventListener("click", function() {
        if(gold >= mageTowerCost) {
          gold -= mageTowerCost;
          mageTowerLevel++;
          mageTowerCost = Math.floor(mageTowerCost * 1.4);
          critMultiplier += 0.1;
          if(!muteSound) upgradeSound.play();
          showNotification("Mage Tower built! Critical multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Mage Tower!"); }
      });
      document.getElementById("buyBarracks").addEventListener("click", function() {
        if(gold >= barracksCost) {
          gold -= barracksCost;
          barracksOwned++;
          barracksCost = Math.floor(barracksCost * 1.25);
          hero.attack += 3;
          if(!muteSound) upgradeSound.play();
          showNotification("Barracks acquired! +3 attack per Barracks.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Barracks!"); }
      });
      document.getElementById("buyMarketplace").addEventListener("click", function() {
        if(gold >= marketplaceCost) {
          gold -= marketplaceCost;
          marketplaceOwned++;
          marketplaceCost = Math.floor(marketplaceCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Marketplace acquired! Passive income boosted.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Marketplace!"); }
      });
      document.getElementById("buyCastle").addEventListener("click", function() {
        if(gold >= castleCost) {
          gold -= castleCost;
          castleOwned++;
          castleCost = Math.floor(castleCost * 1.4);
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Castle built! Gold multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Castle!"); }
      });
      healButton.addEventListener("click", function() {
        if(gold >= healCost) {
          gold -= healCost;
          hero.health = Math.min(hero.health + healAmount, hero.maxHealth);
          showNotification("Healed for " + healAmount + " HP!");
          updateDisplays();
        } else { showNotification("Not enough gold to heal!"); }
      });
      setInterval(function() {
        let income = goldMineOwned * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
        gold += income;
        totalGoldEarned += income;
        updateDisplays();
      }, 1000);
      attackButton.addEventListener("click", function() {
        if(enemy.currentHP > 0) {
          const currentTime = Date.now();
          if(currentTime - lastAttackTime < 2000) {
            comboMultiplier += 0.1;
          } else {
            comboMultiplier = 1;
          }
          lastAttackTime = currentTime;
          let damage = hero.attack * comboMultiplier;
          if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance) {
            showNotification("Enemy dodged your attack!");
          } else {
            enemy.currentHP -= damage;
            if(comboMultiplier > 1) {
              showNotification("Combo x" + comboMultiplier.toFixed(1) + " for " + Math.floor(damage) + " damage!");
            }
          }
          if(enemy.currentHP > 0 && Math.random() < 0.2) {
            let counterDmg = enemy.counterDamage;
            hero.health -= counterDmg;
            showNotification("Enemy counterattacked for " + counterDmg + " damage!");
            if(hero.health <= 0) {
              hero.health = 0;
              showNotification("You died! Prestige to reset.", 4000);
              attackButton.disabled = true;
              specialAttackButton.disabled = true;
              totalBattlesWon++;
              return;
            }
          }
          if(enemy.currentHP <= 0) {
            if(!muteSound) enemyDefeatedSound.play();
            enemyDefeatedCount++;
            totalBattlesWon++;
            if(enemy.type === "Boss") relics++;
            gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
            hero.xp += enemy.rewardXP;
            showNotification("Enemy defeated! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
            spawnEnemy();
            checkLevelUp();
          }
          updateDisplays();
          checkQuests();
          checkAchievements();
        } else { showNotification("Spawn an enemy first!"); }
      });
      specialAttackButton.addEventListener("click", function() {
        if(!specialAvailable) { showNotification("Special Attack is on cooldown!"); return; }
        if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance/2) {
          showNotification("Enemy evaded your Special Attack!");
        } else {
          enemy.currentHP -= hero.attack * 3;
          specialAttackCount++;
          showNotification("Special Attack dealt " + (hero.attack * 3) + " damage!");
        }
        if(enemy.currentHP <= 0) {
          if(!muteSound) enemyDefeatedSound.play();
          enemyDefeatedCount++;
          gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
          hero.xp += enemy.rewardXP;
          showNotification("Enemy defeated with Special Attack! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
          spawnEnemy();
          checkLevelUp();
        }
        updateDisplays();
        specialAvailable = false;
        specialAttackButton.disabled = true;
        specialCooldownRemaining = specialCooldownTime;
      });
      setInterval(function(){
        if(!specialAvailable && specialCooldownRemaining > 0) {
          specialCooldownRemaining--;
          if(specialCooldownRemaining <= 0) {
            specialAvailable = true;
            specialAttackButton.disabled = false;
          }
        }
      }, 1000);
      spawnEnemyButton.addEventListener("click", spawnEnemy);
      // -------------------------
      // PRESTIGE & REINCARNATION
      // -------------------------
      prestigeButton.addEventListener("click", function() {
        if(hero.level < 10) { showNotification("You need to be at least Level 10 to Prestige!"); return; }
        prestigeLevel++;
        prestigePoints++;
        showNotification("Prestige Activated! Gold Multiplier is now " + currentGoldMultiplier().toFixed(1) + "x", 3000);
        if(gold > highScore) highScore = gold;
        leaderboard.push({ name: "Hero", score: gold });
        gold = 0; goldPerClick = 1; goldMineOwned = 0; goldMineCost = 10; clickUpgradeCost = 25;
        critChance = 0.10; critMultiplier = 2; critUpgradeCost = 50;
        autoClickerOwned = 0; autoClickerCost = 50;
        blacksmithLevel = 0; blacksmithCost = 100;
        guildLevel = 0; guildCost = 100;
        mageTowerLevel = 0; mageTowerCost = 150;
        barracksOwned = 0; barracksCost = 200;
        marketplaceOwned = 0; marketplaceCost = 300;
        castleOwned = 0; castleCost = 500;
        hero = { level: 1, xp: 0, xpNeeded: 50, attack: 1, health: 100, maxHealth: 100 };
        spawnEnemy();
        updateDisplays();
        prestigeButton.disabled = true;
        attackButton.disabled = false;
        specialAttackButton.disabled = false;
        logEvent("Prestige activated!");
        updateReincarnation();
      });
      buyPrestigeUpgradeButton.addEventListener("click", function() {
        if(prestigePoints > 0) {
          prestigePoints--;
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Divine Blessing purchased! Bonus multiplier increased.", 2500);
          updateDisplays();
        } else {
          showNotification("Not enough Prestige Points!");
        }
      });
      // -------------------------
      // STATISTICS & EVENT LOG UPDATES
      // -------------------------
      setInterval(() => { checkQuests(); checkAchievements(); }, 2000);
      function updateLeaderboard() {
        leaderboardListElem.innerHTML = "";
        let sorted = leaderboard.sort((a,b) => b.score - a.score).slice(0, 5);
        sorted.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = entry.name + ": " + Math.floor(entry.score);
          leaderboardListElem.appendChild(li);
        });
      }
      // -------------------------
      // SETTINGS & TUTORIAL FUNCTIONS
      // -------------------------
      settingsButton.addEventListener("click", function() {
        settingsModal.style.display = "block";
        musicVolumeSlider.value = musicVolume;
        sfxVolumeSlider.value = sfxVolume;
        muteToggle.checked = muteSound;
        difficultySelect.value = difficultyMultiplier;
        challengeModeToggle.checked = challengeMode;
      });
      closeSettings.addEventListener("click", function() {
        difficultyMultiplier = parseFloat(difficultySelect.value);
        challengeMode = challengeModeToggle.checked;
        settingsModal.style.display = "none";
        showNotification("Settings updated.");
      });
      musicVolumeSlider.addEventListener("input", function() {
        musicVolume = parseFloat(this.value);
        backgroundMusic.volume = musicVolume;
      });
      sfxVolumeSlider.addEventListener("input", function() {
        sfxVolume = parseFloat(this.value);
      });
      muteToggle.addEventListener("change", function() {
        muteSound = this.checked;
        if(muteSound) {
          backgroundMusic.pause();
        } else {
          backgroundMusic.play();
        }
      });
      shareScoreButton.addEventListener("click", function() {
        if(navigator.share) {
          navigator.share({
            title: "Medieval Idle Adventure",
            text: "My high score is " + highScore + " gold and " + relics + " relics!",
          }).then(() => console.log("Score shared!"))
            .catch(err => console.error("Error sharing:", err));
        } else {
          showNotification("Sharing not supported on this browser.");
        }
      });
      dismissTutorial.addEventListener("click", function() {
        tutorialOverlay.style.display = "none";
        localStorage.setItem("tutorialSeen", "true");
        backgroundMusic.play().catch(err => console.log("Music play error:", err));
      });
      // -------------------------
      // MINIâ€‘GAME FUNCTIONS
      // -------------------------
      startMiniGameButton.addEventListener("click", function() {
        miniGameClicks = 0;
        miniGameTimeLeft = 10;
        document.getElementById("miniGameClicks").textContent = miniGameClicks;
        document.getElementById("miniGameTimer").textContent = "Time left: 10s";
        miniGameModal.style.display = "block";
        endMiniGameButton.style.display = "none";
        miniGameInterval = setInterval(() => {
          miniGameTimeLeft--;
          document.getElementById("miniGameTimer").textContent = "Time left: " + miniGameTimeLeft + "s";
          if(miniGameTimeLeft <= 0) {
            clearInterval(miniGameInterval);
            endMiniGame();
          }
        }, 1000);
      });
      miniGameButton.addEventListener("click", function() {
        miniGameClicks++;
        document.getElementById("miniGameClicks").textContent = miniGameClicks;
      });
      endMiniGameButton.addEventListener("click", function() {
        endMiniGame();
      });
      function endMiniGame() {
        clearInterval(miniGameInterval);
        miniGameModal.style.display = "none";
        let bonusGold = miniGameClicks * 10;
        gold += bonusGold;
        showNotification("Miniâ€‘Game complete! You earned " + bonusGold + " bonus gold!");
        addToStatistics(bonusGold, miniGameClicks);
        updateDisplays();
      }
      // -------------------------
      // ENEMY SPAWNING
      // -------------------------
      function spawnEnemy() {
        enemy.level = hero.level;
        let r = Math.random();
        if(r < 0.2) {
          enemy.type = "Boss";
          enemy.maxHP = ((10 + enemy.level * 5) * 3) * difficultyMultiplier * (challengeMode ? 1.2 : 1);
          enemy.rewardGold = ((5 + enemy.level * 2) * 3);
          enemy.rewardXP = ((10 + enemy.level * 3) * 3);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 3;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Boss)";
        } else if(r < 0.3) {
          enemy.type = "Armored";
          enemy.maxHP = Math.floor((10 + enemy.level * 5) * 1.5 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.2);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 0.8);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Armored)";
        } else if(r < 0.4) {
          enemy.type = "Agile";
          enemy.maxHP = (10 + enemy.level * 5) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0.3;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Agile)";
        } else if(r < 0.5) {
          enemy.type = "Regenerator";
          enemy.maxHP = Math.floor((10 + enemy.level * 5) * 1.2 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.1);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 1.1);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = Math.floor(enemy.maxHP * 0.02);
          documentHeaderEnemyType.textContent = "(Regenerator)";
        } else {
          enemy.type = "Normal";
          enemy.maxHP = (10 + enemy.level * 5) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "";
        }
        enemy.currentHP = enemy.maxHP;
        updateDisplays();
      }
      // -------------------------
      // LEVEL-UP & BATTLE FUNCTIONS
      // -------------------------
      function checkLevelUp() {
        while(hero.xp >= hero.xpNeeded) {
          hero.xp -= hero.xpNeeded;
          hero.level++;
          hero.attack++;
          hero.maxHealth += 20;
          hero.health = hero.maxHealth;
          hero.xpNeeded = Math.floor(hero.xpNeeded * 1.5);
          showNotification("Level Up! You are now level " + hero.level + "!", 2500);
          if(!muteSound) levelUpSound.play();
          updateDisplays();
          if(hero.level >= 10) prestigeButton.disabled = false;
        }
      }
      // -------------------------
      // SAVE/LOAD & OFFLINE PROGRESS
      // -------------------------
      function saveGame() {
        try {
          const state = {
            saveVersion,
            gold, goldPerClick, goldMineOwned, goldMineCost, clickUpgradeCost,
            critChance, critMultiplier, critUpgradeCost,
            autoClickerOwned, autoClickerCost, blacksmithLevel, blacksmithCost,
            guildLevel, guildCost, mageTowerLevel, mageTowerCost,
            barracksOwned, barracksCost, marketplaceOwned, marketplaceCost, castleOwned, castleCost,
            hero, enemyDefeatedCount, specialAttackCount,
            prestigeLevel, prestigePoints, bonusMultiplier,
            highScore, passiveBoost, relics,
            quests, achievements, skills,
            lastSaveTime: Date.now(),
            leaderboard
          };
          localStorage.setItem("medievalIdleSave", JSON.stringify(state));
        } catch(e) {
          console.error("Error saving game:", e);
        }
      }
      function loadGame() {
        try {
          const stateStr = localStorage.getItem("medievalIdleSave");
          if(stateStr) {
            const state = JSON.parse(stateStr);
            if(state.saveVersion !== saveVersion) {
              console.warn("Save version mismatch â€“ starting fresh.");
              return;
            }
            gold = state.gold; goldPerClick = state.goldPerClick; goldMineOwned = state.goldMineOwned;
            goldMineCost = state.goldMineCost; clickUpgradeCost = state.clickUpgradeCost;
            critChance = state.critChance; critMultiplier = state.critMultiplier; critUpgradeCost = state.critUpgradeCost;
            autoClickerOwned = state.autoClickerOwned; autoClickerCost = state.autoClickerCost;
            blacksmithLevel = state.blacksmithLevel; blacksmithCost = state.blacksmithCost;
            guildLevel = state.guildLevel; guildCost = state.guildCost;
            mageTowerLevel = state.mageTowerLevel; mageTowerCost = state.mageTowerCost;
            barracksOwned = state.barracksOwned; barracksCost = state.barracksCost;
            marketplaceOwned = state.marketplaceOwned; marketplaceCost = state.marketplaceCost;
            castleOwned = state.castleOwned; castleCost = state.castleCost;
            hero = state.hero; enemyDefeatedCount = state.enemyDefeatedCount; specialAttackCount = state.specialAttackCount;
            prestigeLevel = state.prestigeLevel; prestigePoints = state.prestigePoints; bonusMultiplier = state.bonusMultiplier;
            highScore = state.highScore; passiveBoost = state.passiveBoost; relics = state.relics;
            leaderboard = state.leaderboard || [];
            lastSaveTime = state.lastSaveTime;
            const offlineSeconds = Math.floor((Date.now() - lastSaveTime) / 1000);
            const offlineGold = offlineSeconds * (goldMineOwned + autoClickerOwned * goldPerClick) * currentGoldMultiplier() * getPassiveIncomeMultiplier();
            gold += offlineGold;
            totalGoldEarned += offlineGold;
            showNotification("Welcome back! You earned " + Math.floor(offlineGold) + " gold offline.", 3000);
          }
        } catch(e) {
          console.error("Error loading game:", e);
        }
      }
      window.addEventListener("beforeunload", saveGame);
      window.addEventListener("load", () => {
        loadGame();
        updateDisplays();
        spawnEnemy();
        backgroundMusic.volume = musicVolume;
        backgroundMusic.play().catch(err => console.log("Autoplay prevented", err));
        autoClickerLoop();
        updateDailyChallenge();
        updateReincarnation();
        if(!localStorage.getItem("tutorialSeen")) {
          tutorialOverlay.style.display = "flex";
        }
      });
      // -------------------------
      // AUTO CLICKER LOOP
      // -------------------------
      function autoClickerLoop() {
        setTimeout(function() {
          if(autoClickerOwned > 0) {
            let income = autoClickerOwned * goldPerClick * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
            gold += income;
            totalGoldEarned += income;
            updateDisplays();
          }
          autoClickerLoop();
        }, autoClickInterval);
      }
      // -------------------------
      // GAME LOOP
      // -------------------------
      function gameLoop() {
        updateSpecialCooldownBar();
        if(enemy.type === "Regenerator" && enemy.currentHP > 0) {
          enemy.currentHP = Math.min(enemy.currentHP + enemy.regen * 0.016, enemy.maxHP);
          updateDisplays();
        }
        requestAnimationFrame(gameLoop);
      }
      gameLoop();
      // -------------------------
      // EVENT LISTENERS & GAMEPLAY
      // -------------------------
      clickButton.addEventListener("click", function(e) {
        if(!muteSound) clickSound.play();
        totalClicks++;
        let goldEarned = goldPerClick;
        if(Math.random() < critChance) {
          goldEarned *= critMultiplier;
          showNotification("Critical Strike! +" + Math.floor(goldEarned * currentGoldMultiplier() * temporaryGoldBonus) + " Gold", 1500);
        }
        const totalGold = goldEarned * currentGoldMultiplier() * temporaryGoldBonus;
        gold += totalGold;
        totalGoldEarned += totalGold;
        createGoldFloat(totalGold, e.clientX, e.clientY);
        updateDisplays();
        checkAchievements();
        checkQuests();
      });
      upgradeCritButton.addEventListener("click", function() {
        if(gold >= critUpgradeCost) {
          gold -= critUpgradeCost;
          critChance += 0.05;
          critUpgradeCost = Math.floor(critUpgradeCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade Critical Strike!"); }
      });
      buyGoldMineButton.addEventListener("click", function() {
        if(gold >= goldMineCost) {
          gold -= goldMineCost;
          goldMineOwned++;
          goldMineCost = Math.floor(goldMineCost * 1.15);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
          checkQuests();
        } else { showNotification("Not enough gold for Gold Mine!"); }
      });
      upgradeClickButton.addEventListener("click", function() {
        if(gold >= clickUpgradeCost) {
          gold -= clickUpgradeCost;
          goldPerClick++;
          clickUpgradeCost = Math.floor(clickUpgradeCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade click power!"); }
      });
      buyAutoClickerButton.addEventListener("click", function() {
        if(gold >= autoClickerCost) {
          gold -= autoClickerCost;
          autoClickerOwned++;
          autoClickerCost = Math.floor(autoClickerCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold for Auto Clicker!"); }
      });
      hireBlacksmithButton.addEventListener("click", function() {
        if(gold >= blacksmithCost) {
          gold -= blacksmithCost;
          blacksmithLevel++;
          hero.attack += 1;
          blacksmithCost = Math.floor(blacksmithCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to hire Blacksmith!"); }
      });
      document.getElementById("buyGuild").addEventListener("click", function() {
        if(gold >= guildCost) {
          gold -= guildCost;
          guildLevel++;
          guildCost = Math.floor(guildCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Adventurer's Guild upgraded! Passive income increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Adventurer's Guild!"); }
      });
      document.getElementById("buyMageTower").addEventListener("click", function() {
        if(gold >= mageTowerCost) {
          gold -= mageTowerCost;
          mageTowerLevel++;
          mageTowerCost = Math.floor(mageTowerCost * 1.4);
          critMultiplier += 0.1;
          if(!muteSound) upgradeSound.play();
          showNotification("Mage Tower built! Critical multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Mage Tower!"); }
      });
      document.getElementById("buyBarracks").addEventListener("click", function() {
        if(gold >= barracksCost) {
          gold -= barracksCost;
          barracksOwned++;
          barracksCost = Math.floor(barracksCost * 1.25);
          hero.attack += 3;
          if(!muteSound) upgradeSound.play();
          showNotification("Barracks acquired! +3 attack per Barracks.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Barracks!"); }
      });
      document.getElementById("buyMarketplace").addEventListener("click", function() {
        if(gold >= marketplaceCost) {
          gold -= marketplaceCost;
          marketplaceOwned++;
          marketplaceCost = Math.floor(marketplaceCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Marketplace acquired! Passive income boosted.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Marketplace!"); }
      });
      document.getElementById("buyCastle").addEventListener("click", function() {
        if(gold >= castleCost) {
          gold -= castleCost;
          castleOwned++;
          castleCost = Math.floor(castleCost * 1.4);
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Castle built! Gold multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Castle!"); }
      });
      healButton.addEventListener("click", function() {
        if(gold >= healCost) {
          gold -= healCost;
          hero.health = Math.min(hero.health + healAmount, hero.maxHealth);
          showNotification("Healed for " + healAmount + " HP!");
          updateDisplays();
        } else { showNotification("Not enough gold to heal!"); }
      });
      setInterval(function() {
        let income = goldMineOwned * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
        gold += income;
        totalGoldEarned += income;
        updateDisplays();
      }, 1000);
      attackButton.addEventListener("click", function() {
        if(enemy.currentHP > 0) {
          const currentTime = Date.now();
          if(currentTime - lastAttackTime < 2000) {
            comboMultiplier += 0.1;
          } else {
            comboMultiplier = 1;
          }
          lastAttackTime = currentTime;
          let damage = hero.attack * comboMultiplier;
          if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance) {
            showNotification("Enemy dodged your attack!");
          } else {
            enemy.currentHP -= damage;
            if(comboMultiplier > 1) {
              showNotification("Combo x" + comboMultiplier.toFixed(1) + " for " + Math.floor(damage) + " damage!");
            }
          }
          if(enemy.currentHP > 0 && Math.random() < 0.2) {
            let counterDmg = enemy.counterDamage;
            hero.health -= counterDmg;
            showNotification("Enemy counterattacked for " + counterDmg + " damage!");
            if(hero.health <= 0) {
              hero.health = 0;
              showNotification("You died! Prestige to reset.", 4000);
              attackButton.disabled = true;
              specialAttackButton.disabled = true;
              totalBattlesWon++;
              return;
            }
          }
          if(enemy.currentHP <= 0) {
            if(!muteSound) enemyDefeatedSound.play();
            enemyDefeatedCount++;
            totalBattlesWon++;
            if(enemy.type === "Boss") relics++;
            gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
            hero.xp += enemy.rewardXP;
            showNotification("Enemy defeated! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
            spawnEnemy();
            checkLevelUp();
          }
          updateDisplays();
          checkQuests();
          checkAchievements();
        } else { showNotification("Spawn an enemy first!"); }
      });
      specialAttackButton.addEventListener("click", function() {
        if(!specialAvailable) { showNotification("Special Attack is on cooldown!"); return; }
        if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance/2) {
          showNotification("Enemy evaded your Special Attack!");
        } else {
          enemy.currentHP -= hero.attack * 3;
          specialAttackCount++;
          showNotification("Special Attack dealt " + (hero.attack * 3) + " damage!");
        }
        if(enemy.currentHP <= 0) {
          if(!muteSound) enemyDefeatedSound.play();
          enemyDefeatedCount++;
          gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
          hero.xp += enemy.rewardXP;
          showNotification("Enemy defeated with Special Attack! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
          spawnEnemy();
          checkLevelUp();
        }
        updateDisplays();
        specialAvailable = false;
        specialAttackButton.disabled = true;
        specialCooldownRemaining = specialCooldownTime;
      });
      setInterval(function(){
        if(!specialAvailable && specialCooldownRemaining > 0) {
          specialCooldownRemaining--;
          if(specialCooldownRemaining <= 0) {
            specialAvailable = true;
            specialAttackButton.disabled = false;
          }
        }
      }, 1000);
      spawnEnemyButton.addEventListener("click", spawnEnemy);
      // -------------------------
      // PRESTIGE & REINCARNATION
      // -------------------------
      prestigeButton.addEventListener("click", function() {
        if(hero.level < 10) { showNotification("You need to be at least Level 10 to Prestige!"); return; }
        prestigeLevel++;
        prestigePoints++;
        showNotification("Prestige Activated! Gold Multiplier is now " + currentGoldMultiplier().toFixed(1) + "x", 3000);
        if(gold > highScore) highScore = gold;
        leaderboard.push({ name: "Hero", score: gold });
        gold = 0; goldPerClick = 1; goldMineOwned = 0; goldMineCost = 10; clickUpgradeCost = 25;
        critChance = 0.10; critMultiplier = 2; critUpgradeCost = 50;
        autoClickerOwned = 0; autoClickerCost = 50;
        blacksmithLevel = 0; blacksmithCost = 100;
        guildLevel = 0; guildCost = 100;
        mageTowerLevel = 0; mageTowerCost = 150;
        barracksOwned = 0; barracksCost = 200;
        marketplaceOwned = 0; marketplaceCost = 300;
        castleOwned = 0; castleCost = 500;
        hero = { level: 1, xp: 0, xpNeeded: 50, attack: 1, health: 100, maxHealth: 100 };
        spawnEnemy();
        updateDisplays();
        prestigeButton.disabled = true;
        attackButton.disabled = false;
        specialAttackButton.disabled = false;
        logEvent("Prestige activated!");
        updateReincarnation();
      });
      buyPrestigeUpgradeButton.addEventListener("click", function() {
        if(prestigePoints > 0) {
          prestigePoints--;
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Divine Blessing purchased! Bonus multiplier increased.", 2500);
          updateDisplays();
        } else {
          showNotification("Not enough Prestige Points!");
        }
      });
      // -------------------------
      // STATISTICS & EVENT LOG UPDATES
      // -------------------------
      setInterval(() => { checkQuests(); checkAchievements(); }, 2000);
      function updateLeaderboard() {
        leaderboardListElem.innerHTML = "";
        let sorted = leaderboard.sort((a,b) => b.score - a.score).slice(0, 5);
        sorted.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = entry.name + ": " + Math.floor(entry.score);
          leaderboardListElem.appendChild(li);
        });
      }
      // -------------------------
      // SETTINGS & TUTORIAL FUNCTIONS
      // -------------------------
      settingsButton.addEventListener("click", function() {
        settingsModal.style.display = "block";
        musicVolumeSlider.value = musicVolume;
        sfxVolumeSlider.value = sfxVolume;
        muteToggle.checked = muteSound;
        difficultySelect.value = difficultyMultiplier;
        challengeModeToggle.checked = challengeMode;
      });
      closeSettings.addEventListener("click", function() {
        difficultyMultiplier = parseFloat(difficultySelect.value);
        challengeMode = challengeModeToggle.checked;
        settingsModal.style.display = "none";
        showNotification("Settings updated.");
      });
      musicVolumeSlider.addEventListener("input", function() {
        musicVolume = parseFloat(this.value);
        backgroundMusic.volume = musicVolume;
      });
      sfxVolumeSlider.addEventListener("input", function() {
        sfxVolume = parseFloat(this.value);
      });
      muteToggle.addEventListener("change", function() {
        muteSound = this.checked;
        if(muteSound) {
          backgroundMusic.pause();
        } else {
          backgroundMusic.play();
        }
      });
      shareScoreButton.addEventListener("click", function() {
        if(navigator.share) {
          navigator.share({
            title: "Medieval Idle Adventure",
            text: "My high score is " + highScore + " gold and " + relics + " relics!",
          }).then(() => console.log("Score shared!"))
            .catch(err => console.error("Error sharing:", err));
        } else {
          showNotification("Sharing not supported on this browser.");
        }
      });
      dismissTutorial.addEventListener("click", function() {
        tutorialOverlay.style.display = "none";
        localStorage.setItem("tutorialSeen", "true");
        backgroundMusic.play().catch(err => console.log("Music play error:", err));
      });
      // -------------------------
      // MINIâ€‘GAME FUNCTIONS
      // -------------------------
      startMiniGameButton.addEventListener("click", function() {
        miniGameClicks = 0;
        miniGameTimeLeft = 10;
        document.getElementById("miniGameClicks").textContent = miniGameClicks;
        document.getElementById("miniGameTimer").textContent = "Time left: 10s";
        miniGameModal.style.display = "block";
        endMiniGameButton.style.display = "none";
        miniGameInterval = setInterval(() => {
          miniGameTimeLeft--;
          document.getElementById("miniGameTimer").textContent = "Time left: " + miniGameTimeLeft + "s";
          if(miniGameTimeLeft <= 0) {
            clearInterval(miniGameInterval);
            endMiniGame();
          }
        }, 1000);
      });
      miniGameButton.addEventListener("click", function() {
        miniGameClicks++;
        document.getElementById("miniGameClicks").textContent = miniGameClicks;
      });
      endMiniGameButton.addEventListener("click", function() {
        endMiniGame();
      });
      function endMiniGame() {
        clearInterval(miniGameInterval);
        miniGameModal.style.display = "none";
        let bonusGold = miniGameClicks * 10;
        gold += bonusGold;
        showNotification("Miniâ€‘Game complete! You earned " + bonusGold + " bonus gold!");
        addToStatistics(bonusGold, miniGameClicks);
        updateDisplays();
      }
      // -------------------------
      // ENEMY SPAWNING
      // -------------------------
      function spawnEnemy() {
        enemy.level = hero.level;
        let r = Math.random();
        if(r < 0.2) {
          enemy.type = "Boss";
          enemy.maxHP = ((10 + enemy.level * 5) * 3) * difficultyMultiplier * (challengeMode ? 1.2 : 1);
          enemy.rewardGold = ((5 + enemy.level * 2) * 3);
          enemy.rewardXP = ((10 + enemy.level * 3) * 3);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 3;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Boss)";
        } else if(r < 0.3) {
          enemy.type = "Armored";
          enemy.maxHP = Math.floor((10 + enemy.level * 5) * 1.5 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.2);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 0.8);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Armored)";
        } else if(r < 0.4) {
          enemy.type = "Agile";
          enemy.maxHP = (10 + enemy.level * 5) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0.3;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "(Agile)";
        } else if(r < 0.5) {
          enemy.type = "Regenerator";
          enemy.maxHP = Math.floor((10 + enemy.level * 5) * 1.2 * difficultyMultiplier);
          enemy.rewardGold = Math.floor((5 + enemy.level * 2) * 1.1);
          enemy.rewardXP = Math.floor((10 + enemy.level * 3) * 1.1);
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = Math.floor(enemy.maxHP * 0.02);
          documentHeaderEnemyType.textContent = "(Regenerator)";
        } else {
          enemy.type = "Normal";
          enemy.maxHP = (10 + enemy.level * 5) * difficultyMultiplier;
          enemy.rewardGold = 5 + enemy.level * 2;
          enemy.rewardXP = 10 + enemy.level * 3;
          enemy.dodgeChance = 0;
          enemy.counterDamage = enemy.level * 2;
          enemy.regen = 0;
          documentHeaderEnemyType.textContent = "";
        }
        enemy.currentHP = enemy.maxHP;
        updateDisplays();
      }
      // -------------------------
      // LEVEL-UP & BATTLE FUNCTIONS
      // -------------------------
      function checkLevelUp() {
        while(hero.xp >= hero.xpNeeded) {
          hero.xp -= hero.xpNeeded;
          hero.level++;
          hero.attack++;
          hero.maxHealth += 20;
          hero.health = hero.maxHealth;
          hero.xpNeeded = Math.floor(hero.xpNeeded * 1.5);
          showNotification("Level Up! You are now level " + hero.level + "!", 2500);
          if(!muteSound) levelUpSound.play();
          updateDisplays();
          if(hero.level >= 10) prestigeButton.disabled = false;
        }
      }
      // -------------------------
      // SAVE/LOAD & OFFLINE PROGRESS
      // -------------------------
      function saveGame() {
        try {
          const state = {
            saveVersion,
            gold, goldPerClick, goldMineOwned, goldMineCost, clickUpgradeCost,
            critChance, critMultiplier, critUpgradeCost,
            autoClickerOwned, autoClickerCost, blacksmithLevel, blacksmithCost,
            guildLevel, guildCost, mageTowerLevel, mageTowerCost,
            barracksOwned, barracksCost, marketplaceOwned, marketplaceCost, castleOwned, castleCost,
            hero, enemyDefeatedCount, specialAttackCount,
            prestigeLevel, prestigePoints, bonusMultiplier,
            highScore, passiveBoost, relics,
            quests, achievements, skills,
            lastSaveTime: Date.now(),
            leaderboard
          };
          localStorage.setItem("medievalIdleSave", JSON.stringify(state));
        } catch(e) {
          console.error("Error saving game:", e);
        }
      }
      function loadGame() {
        try {
          const stateStr = localStorage.getItem("medievalIdleSave");
          if(stateStr) {
            const state = JSON.parse(stateStr);
            if(state.saveVersion !== saveVersion) {
              console.warn("Save version mismatch â€“ starting fresh.");
              return;
            }
            gold = state.gold; goldPerClick = state.goldPerClick; goldMineOwned = state.goldMineOwned;
            goldMineCost = state.goldMineCost; clickUpgradeCost = state.clickUpgradeCost;
            critChance = state.critChance; critMultiplier = state.critMultiplier; critUpgradeCost = state.critUpgradeCost;
            autoClickerOwned = state.autoClickerOwned; autoClickerCost = state.autoClickerCost;
            blacksmithLevel = state.blacksmithLevel; blacksmithCost = state.blacksmithCost;
            guildLevel = state.guildLevel; guildCost = state.guildCost;
            mageTowerLevel = state.mageTowerLevel; mageTowerCost = state.mageTowerCost;
            barracksOwned = state.barracksOwned; barracksCost = state.barracksCost;
            marketplaceOwned = state.marketplaceOwned; marketplaceCost = state.marketplaceCost;
            castleOwned = state.castleOwned; castleCost = state.castleCost;
            hero = state.hero; enemyDefeatedCount = state.enemyDefeatedCount; specialAttackCount = state.specialAttackCount;
            prestigeLevel = state.prestigeLevel; prestigePoints = state.prestigePoints; bonusMultiplier = state.bonusMultiplier;
            highScore = state.highScore; passiveBoost = state.passiveBoost; relics = state.relics;
            leaderboard = state.leaderboard || [];
            lastSaveTime = state.lastSaveTime;
            const offlineSeconds = Math.floor((Date.now() - lastSaveTime) / 1000);
            const offlineGold = offlineSeconds * (goldMineOwned + autoClickerOwned * goldPerClick) * currentGoldMultiplier() * getPassiveIncomeMultiplier();
            gold += offlineGold;
            totalGoldEarned += offlineGold;
            showNotification("Welcome back! You earned " + Math.floor(offlineGold) + " gold offline.", 3000);
          }
        } catch(e) {
          console.error("Error loading game:", e);
        }
      }
      window.addEventListener("beforeunload", saveGame);
      window.addEventListener("load", () => {
        loadGame();
        updateDisplays();
        spawnEnemy();
        backgroundMusic.volume = musicVolume;
        backgroundMusic.play().catch(err => console.log("Autoplay prevented", err));
        autoClickerLoop();
        updateDailyChallenge();
        updateReincarnation();
        if(!localStorage.getItem("tutorialSeen")) {
          tutorialOverlay.style.display = "flex";
        }
      });
      // -------------------------
      // AUTO CLICKER LOOP
      // -------------------------
      function autoClickerLoop() {
        setTimeout(function() {
          if(autoClickerOwned > 0) {
            let income = autoClickerOwned * goldPerClick * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
            gold += income;
            totalGoldEarned += income;
            updateDisplays();
          }
          autoClickerLoop();
        }, autoClickInterval);
      }
      // -------------------------
      // GAME LOOP
      // -------------------------
      function gameLoop() {
        updateSpecialCooldownBar();
        if(enemy.type === "Regenerator" && enemy.currentHP > 0) {
          enemy.currentHP = Math.min(enemy.currentHP + enemy.regen * 0.016, enemy.maxHP);
          updateDisplays();
        }
        requestAnimationFrame(gameLoop);
      }
      gameLoop();
      // -------------------------
      // EVENT LISTENERS & GAMEPLAY
      // -------------------------
      clickButton.addEventListener("click", function(e) {
        if(!muteSound) clickSound.play();
        totalClicks++;
        let goldEarned = goldPerClick;
        if(Math.random() < critChance) {
          goldEarned *= critMultiplier;
          showNotification("Critical Strike! +" + Math.floor(goldEarned * currentGoldMultiplier() * temporaryGoldBonus) + " Gold", 1500);
        }
        const totalGold = goldEarned * currentGoldMultiplier() * temporaryGoldBonus;
        gold += totalGold;
        totalGoldEarned += totalGold;
        createGoldFloat(totalGold, e.clientX, e.clientY);
        updateDisplays();
        checkAchievements();
        checkQuests();
      });
      upgradeCritButton.addEventListener("click", function() {
        if(gold >= critUpgradeCost) {
          gold -= critUpgradeCost;
          critChance += 0.05;
          critUpgradeCost = Math.floor(critUpgradeCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade Critical Strike!"); }
      });
      buyGoldMineButton.addEventListener("click", function() {
        if(gold >= goldMineCost) {
          gold -= goldMineCost;
          goldMineOwned++;
          goldMineCost = Math.floor(goldMineCost * 1.15);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
          checkQuests();
        } else { showNotification("Not enough gold for Gold Mine!"); }
      });
      upgradeClickButton.addEventListener("click", function() {
        if(gold >= clickUpgradeCost) {
          gold -= clickUpgradeCost;
          goldPerClick++;
          clickUpgradeCost = Math.floor(clickUpgradeCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to upgrade click power!"); }
      });
      buyAutoClickerButton.addEventListener("click", function() {
        if(gold >= autoClickerCost) {
          gold -= autoClickerCost;
          autoClickerOwned++;
          autoClickerCost = Math.floor(autoClickerCost * 1.2);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold for Auto Clicker!"); }
      });
      hireBlacksmithButton.addEventListener("click", function() {
        if(gold >= blacksmithCost) {
          gold -= blacksmithCost;
          blacksmithLevel++;
          hero.attack += 1;
          blacksmithCost = Math.floor(blacksmithCost * 1.5);
          if(!muteSound) upgradeSound.play();
          updateDisplays();
        } else { showNotification("Not enough gold to hire Blacksmith!"); }
      });
      document.getElementById("buyGuild").addEventListener("click", function() {
        if(gold >= guildCost) {
          gold -= guildCost;
          guildLevel++;
          guildCost = Math.floor(guildCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Adventurer's Guild upgraded! Passive income increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Adventurer's Guild!"); }
      });
      document.getElementById("buyMageTower").addEventListener("click", function() {
        if(gold >= mageTowerCost) {
          gold -= mageTowerCost;
          mageTowerLevel++;
          mageTowerCost = Math.floor(mageTowerCost * 1.4);
          critMultiplier += 0.1;
          if(!muteSound) upgradeSound.play();
          showNotification("Mage Tower built! Critical multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Mage Tower!"); }
      });
      document.getElementById("buyBarracks").addEventListener("click", function() {
        if(gold >= barracksCost) {
          gold -= barracksCost;
          barracksOwned++;
          barracksCost = Math.floor(barracksCost * 1.25);
          hero.attack += 3;
          if(!muteSound) upgradeSound.play();
          showNotification("Barracks acquired! +3 attack per Barracks.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Barracks!"); }
      });
      document.getElementById("buyMarketplace").addEventListener("click", function() {
        if(gold >= marketplaceCost) {
          gold -= marketplaceCost;
          marketplaceOwned++;
          marketplaceCost = Math.floor(marketplaceCost * 1.3);
          if(!muteSound) upgradeSound.play();
          showNotification("Marketplace acquired! Passive income boosted.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Marketplace!"); }
      });
      document.getElementById("buyCastle").addEventListener("click", function() {
        if(gold >= castleCost) {
          gold -= castleCost;
          castleOwned++;
          castleCost = Math.floor(castleCost * 1.4);
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Castle built! Gold multiplier increased.", 2000);
          updateDisplays();
        } else { showNotification("Not enough gold for Castle!"); }
      });
      healButton.addEventListener("click", function() {
        if(gold >= healCost) {
          gold -= healCost;
          hero.health = Math.min(hero.health + healAmount, hero.maxHealth);
          showNotification("Healed for " + healAmount + " HP!");
          updateDisplays();
        } else { showNotification("Not enough gold to heal!"); }
      });
      setInterval(function() {
        let income = goldMineOwned * currentGoldMultiplier() * getPassiveIncomeMultiplier() * temporaryGoldBonus;
        gold += income;
        totalGoldEarned += income;
        updateDisplays();
      }, 1000);
      attackButton.addEventListener("click", function() {
        if(enemy.currentHP > 0) {
          const currentTime = Date.now();
          if(currentTime - lastAttackTime < 2000) {
            comboMultiplier += 0.1;
          } else {
            comboMultiplier = 1;
          }
          lastAttackTime = currentTime;
          let damage = hero.attack * comboMultiplier;
          if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance) {
            showNotification("Enemy dodged your attack!");
          } else {
            enemy.currentHP -= damage;
            if(comboMultiplier > 1) {
              showNotification("Combo x" + comboMultiplier.toFixed(1) + " for " + Math.floor(damage) + " damage!");
            }
          }
          if(enemy.currentHP > 0 && Math.random() < 0.2) {
            let counterDmg = enemy.counterDamage;
            hero.health -= counterDmg;
            showNotification("Enemy counterattacked for " + counterDmg + " damage!");
            if(hero.health <= 0) {
              hero.health = 0;
              showNotification("You died! Prestige to reset.", 4000);
              attackButton.disabled = true;
              specialAttackButton.disabled = true;
              totalBattlesWon++;
              return;
            }
          }
          if(enemy.currentHP <= 0) {
            if(!muteSound) enemyDefeatedSound.play();
            enemyDefeatedCount++;
            totalBattlesWon++;
            if(enemy.type === "Boss") relics++;
            gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
            hero.xp += enemy.rewardXP;
            showNotification("Enemy defeated! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
            spawnEnemy();
            checkLevelUp();
          }
          updateDisplays();
          checkQuests();
          checkAchievements();
        } else { showNotification("Spawn an enemy first!"); }
      });
      specialAttackButton.addEventListener("click", function() {
        if(!specialAvailable) { showNotification("Special Attack is on cooldown!"); return; }
        if(enemy.type === "Agile" && Math.random() < enemy.dodgeChance/2) {
          showNotification("Enemy evaded your Special Attack!");
        } else {
          enemy.currentHP -= hero.attack * 3;
          specialAttackCount++;
          showNotification("Special Attack dealt " + (hero.attack * 3) + " damage!");
        }
        if(enemy.currentHP <= 0) {
          if(!muteSound) enemyDefeatedSound.play();
          enemyDefeatedCount++;
          gold += enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus;
          hero.xp += enemy.rewardXP;
          showNotification("Enemy defeated with Special Attack! Gained " + Math.floor(enemy.rewardGold * currentGoldMultiplier() * temporaryGoldBonus) + " Gold and " + enemy.rewardXP + " XP!");
          spawnEnemy();
          checkLevelUp();
        }
        updateDisplays();
        specialAvailable = false;
        specialAttackButton.disabled = true;
        specialCooldownRemaining = specialCooldownTime;
      });
      setInterval(function(){
        if(!specialAvailable && specialCooldownRemaining > 0) {
          specialCooldownRemaining--;
          if(specialCooldownRemaining <= 0) {
            specialAvailable = true;
            specialAttackButton.disabled = false;
          }
        }
      }, 1000);
      spawnEnemyButton.addEventListener("click", spawnEnemy);
      // -------------------------
      // PRESTIGE & REINCARNATION
      // -------------------------
      prestigeButton.addEventListener("click", function() {
        if(hero.level < 10) { showNotification("You need to be at least Level 10 to Prestige!"); return; }
        prestigeLevel++;
        prestigePoints++;
        showNotification("Prestige Activated! Gold Multiplier is now " + currentGoldMultiplier().toFixed(1) + "x", 3000);
        if(gold > highScore) highScore = gold;
        leaderboard.push({ name: "Hero", score: gold });
        gold = 0; goldPerClick = 1; goldMineOwned = 0; goldMineCost = 10; clickUpgradeCost = 25;
        critChance = 0.10; critMultiplier = 2; critUpgradeCost = 50;
        autoClickerOwned = 0; autoClickerCost = 50;
        blacksmithLevel = 0; blacksmithCost = 100;
        guildLevel = 0; guildCost = 100;
        mageTowerLevel = 0; mageTowerCost = 150;
        barracksOwned = 0; barracksCost = 200;
        marketplaceOwned = 0; marketplaceCost = 300;
        castleOwned = 0; castleCost = 500;
        hero = { level: 1, xp: 0, xpNeeded: 50, attack: 1, health: 100, maxHealth: 100 };
        spawnEnemy();
        updateDisplays();
        prestigeButton.disabled = true;
        attackButton.disabled = false;
        specialAttackButton.disabled = false;
        logEvent("Prestige activated!");
        updateReincarnation();
      });
      buyPrestigeUpgradeButton.addEventListener("click", function() {
        if(prestigePoints > 0) {
          prestigePoints--;
          bonusMultiplier += 0.2;
          if(!muteSound) upgradeSound.play();
          showNotification("Divine Blessing purchased! Bonus multiplier increased.", 2500);
          updateDisplays();
        } else {
          showNotification("Not enough Prestige Points!");
        }
      });
      // -------------------------
      // STATISTICS & EVENT LOG UPDATES
      // -------------------------
      setInterval(() => { checkQuests(); checkAchievements(); }, 2000);
      function updateLeaderboard() {
        leaderboardListElem.innerHTML = "";
        let sorted = leaderboard.sort((a,b) => b.score - a.score).slice(0, 5);
        sorted.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = entry.name + ": " + Math.floor(entry.score);
          leaderboardListElem.appendChild(li);
        });
      }
      // -------------------------
      // SETTINGS & TUTORIAL FUNCTIONS
      // -------------------------
      settingsButton.addEventListener("click", function() {
        settingsModal.style.display = "block";
        musicVolumeSlider.value = musicVolume;
        sfxVolumeSlider.value = sfxVolume;
        muteToggle.checked = muteSound;
        difficultySelect.value = difficultyMultiplier;
        challengeModeToggle.checked = challengeMode;
      });
      closeSettings.addEventListener("click", function() {
        difficultyMultiplier = parseFloat(difficultySelect.value);
        challengeMode = challengeModeToggle.checked;
        settingsModal.style.display = "none";
        showNotification("Settings updated.");
      });
      musicVolumeSlider.addEventListener("input", function() {
        musicVolume = parseFloat(this.value);
        backgroundMusic.volume = musicVolume;
      });
      sfxVolumeSlider.addEventListener("input", function() {
        sfxVolume = parseFloat(this.value);
      });
      muteToggle.addEventListener("change", function() {
        muteSound = this.checked;
        if(muteSound) {
          backgroundMusic.pause();
        } else {
          backgroundMusic.play();
        }
      });
      shareScoreButton.addEventListener("click", function() {
        if(navigator.share) {
          navigator.share({
            title: "Medieval Idle Adventure",
            text: "My high score is " + highScore + " gold and " + relics + " relics!",
          }).then(() => console.log("Score shared!"))
            .catch(err => console.error("Error sharing:", err));
        } else {
          showNotification("Sharing not supported on this browser.");
        }
      });
      dismissTutorial.addEventListener("click", function() {
        tutorialOverlay.style.display = "none";
        localStorage.setItem("tutorialSeen", "true");
        backgroundMusic.play().catch(err => console.log("Music play error:", err));
      });
      // -------------------------
      // END OF SCRIPT
    })();
  </script>
</body>
</html>
